<!DOCTYPE html>

<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>è‡ªç«‹å¤§å†’éšª - è‡ªç«‹ç”Ÿæ´»æ¨¡æ“¬å™¨</title>

  <!-- Tailwind CSS CDN -->

  <script defer src="https://cdn.tailwindcss.com" crossorigin="anonymous"></script>
  <!-- React 18 / ReactDOM 18 -->
 <script defer src="https://cdn.jsdelivr.net/npm/react@18.2.0/umd/react.production.min.js" crossorigin="anonymous"></script>
 <script defer src="https://cdn.jsdelivr.net/npm/react-dom@18.2.0/umd/react-dom.production.min.js" crossorigin="anonymous"></script>
  <!-- Babel -->
  <script defer src="https://cdn.jsdelivr.net/npm/@babel/standalone@7.24.7/babel.min.js" crossorigin="anonymous"></script>
  <!-- Fonts -->

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=VT323&family=Noto+Sans+TC:wght@400;600;700&display=swap" rel="stylesheet">

  <style>
    :root{
      --neo-shadow: 4px 4px 0 #000;
      --neo-border: 2px solid #000;
      --bg-dark: #0b1220;
    }
    html, body {
      height: 100%;
      background: radial-gradient(1200px 800px at 50% 0%, #1b2a4a 0%, #0b1220 55%, #070b14 100%);
      margin: 0;
      font-family: "Noto Sans TC", system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial;
      overflow: hidden;
    }
    .font-pixel { font-family: "VT323", monospace; letter-spacing: 0.5px; }
    .neo-card{
      border: var(--neo-border);
      box-shadow: var(--neo-shadow);
      border-radius: 18px;
      background: #fff;
    }
    .neo-soft{
      border: var(--neo-border);
      box-shadow: 3px 3px 0 #000;
      border-radius: 14px;
      background: #fff;
    }
    .neo-btn{
      border: var(--neo-border);
      box-shadow: 4px 4px 0 #000;
      transform: translate(0,0);
      transition: transform 120ms ease, box-shadow 120ms ease, filter 120ms ease;
      user-select: none;
      -webkit-tap-highlight-color: transparent;
    }
    .neo-btn:active{
      transform: translate(3px,3px);
      box-shadow: 1px 1px 0 #000;
      filter: brightness(0.98);
    }

    /* Phone shell */
    .phone-shell{
      width: min(390px, 92vw);
      height: min(820px, 92vh);
      border-radius: 36px;
      background: linear-gradient(180deg, #111827 0%, #0b1220 100%);
      border: 2px solid rgba(255,255,255,0.08);
      box-shadow: 0 30px 80px rgba(0,0,0,0.55);
      position: relative;
      padding: 16px;
    }
    .phone-notch{
      position: absolute;
      top: 10px;
      left: 50%;
      transform: translateX(-50%);
      width: 180px;
      height: 30px;
      border-radius: 0 0 18px 18px;
      background: rgba(0,0,0,0.55);
      border: 1px solid rgba(255,255,255,0.08);
      z-index: 20;
    }
    .phone-side-btn{
      position: absolute;
      width: 6px;
      height: 60px;
      border-radius: 999px;
      background: rgba(255,255,255,0.12);
      border: 1px solid rgba(0,0,0,0.3);
      box-shadow: inset -1px 0 0 rgba(0,0,0,0.35);
    }
    .phone-side-btn.left1{ left: -4px; top: 140px; height: 46px; }
    .phone-side-btn.left2{ left: -4px; top: 200px; height: 74px; }
    .phone-side-btn.right1{ right: -4px; top: 170px; height: 92px; }

    /* App screen area */
    .screen{
      width: 100%;
      height: 100%;
      border-radius: 26px;
      background: #f8fafc;
      overflow: hidden;
      border: 2px solid rgba(0,0,0,0.35);
      box-shadow: inset 0 0 0 2px rgba(255,255,255,0.06);
      position: relative;
    }

    /* Scanlines */
    .scanlines::before{
      content:"";
      position:absolute;
      inset:0;
      background: repeating-linear-gradient(
        to bottom,
        rgba(0,0,0,0.05),
        rgba(0,0,0,0.05) 1px,
        rgba(0,0,0,0.00) 3px,
        rgba(0,0,0,0.00) 6px
      );
      pointer-events:none;
      mix-blend-mode:multiply;
      opacity: 0.55;
      z-index: 5;
    }

    /* Glitch */
    @keyframes glitchShift {
      0% { transform: translate(0,0); filter: none; }
      20% { transform: translate(-2px, 1px); filter: contrast(1.15) saturate(1.1); }
      40% { transform: translate(2px, -1px); filter: hue-rotate(10deg) contrast(1.2); }
      60% { transform: translate(-1px, -2px); filter: hue-rotate(-10deg) contrast(1.15); }
      80% { transform: translate(1px, 2px); filter: saturate(1.2); }
      100% { transform: translate(0,0); filter: none; }
    }
    .glitch-effect{
      animation: glitchShift 450ms ease-in-out 1;
    }

    /* Modal pop */
    @keyframes popIn {
      0% { transform: translateY(10px) scale(0.96); opacity: 0; }
      70% { transform: translateY(-2px) scale(1.01); opacity: 1; }
      100% { transform: translateY(0) scale(1); opacity: 1; }
    }
    .pop-in{ animation: popIn 220ms ease-out 1; }

    /* Floating text */
    @keyframes floatUp {
      0% { transform: translateY(0); opacity: 0; }
      15% { opacity: 1; }
      100% { transform: translateY(-34px); opacity: 0; }
    }
    .float-up{ animation: floatUp 900ms ease-out forwards; }

    /* Error message container */
    #error-message{
      position: fixed;
      left: 50%;
      transform: translateX(-50%);
      bottom: 14px;
      max-width: min(920px, 92vw);
      width: min(920px, 92vw);
      z-index: 9999;
      border: 2px solid #000;
      box-shadow: 4px 4px 0 #000;
      background: #fff1f2;
      color: #9f1239;
      font-weight: 700;
      border-radius: 16px;
      padding: 10px 12px;
      display: none;
      white-space: pre-wrap;
    }
  </style>

</head>

<body>
  <div class="min-h-screen w-full flex items-center justify-center p-6">
    <div class="phone-shell">
      <div class="phone-notch"></div>
      <div class="phone-side-btn left1"></div>
      <div class="phone-side-btn left2"></div>
      <div class="phone-side-btn right1"></div>

```
  <div class="screen scanlines" id="screen">
    <div id="root" class="relative z-10 w-full h-full"></div>
  </div>
</div>
```

  </div>

  <div id="error-message"></div>

  <script>
    (function(){
      const box = document.getElementById("error-message");
      function showError(msg){
        if(!box) return;
        box.style.display = "block";
        box.textContent = msg;
      }
      window.onerror = function(message, source, lineno, colno, error){
        const detail = [
          "âš ï¸ æ•ç²åˆ°éŒ¯èª¤ï¼ˆwindow.onerrorï¼‰",
          String(message || ""),
          source ? ("ä¾†æº: " + source) : "",
          (lineno != null ? ("è¡Œ: " + lineno) : "") + (colno != null ? (" åˆ—: " + colno) : ""),
          error && error.stack ? ("\n" + error.stack) : ""
        ].filter(Boolean).join("\n");
        showError(detail);
        return false;
      };
      window.onunhandledrejection = function(ev){
        const reason = ev && ev.reason ? ev.reason : "(unknown)";
        const detail = [
          "âš ï¸ æ•ç²åˆ° Promise éŒ¯èª¤ï¼ˆunhandledrejectionï¼‰",
          (typeof reason === "string" ? reason : (reason && reason.message ? reason.message : JSON.stringify(reason))),
          reason && reason.stack ? ("\n" + reason.stack) : ""
        ].filter(Boolean).join("\n");
        showError(detail);
      };
      window.__showErrorBox = showError;
    })();
  </script>

  <script type="text/babel">
    const { useEffect, useMemo, useRef, useState } = React;

    /********************
     * Data (å…§å»º)
     ********************/
    const INITIAL_STATS = {
      money: 0,
      health: 100,
      mood: 55,
      security: 55,
      week: 1,
      maxWeeks: 8,
      age: 16,
      ap: 3,
      maxAp: 3,
    };

    const CHARACTER_ORIGINS = [
      { grade: "A", money: 0,    prob: 0.10, label: "èµ·æ­¥è‰±é›£" },
      { grade: "B", money: 2000, prob: 0.30, label: "åŸºæœ¬èµ·æ­¥" },
      { grade: "C", money: 4000, prob: 0.30, label: "ä¸€èˆ¬èµ·æ­¥" },
      { grade: "D", money: 6000, prob: 0.20, label: "ç›¸å°ç©©å®š" },
      { grade: "E", money: 8000, prob: 0.10, label: "è³‡æºè¼ƒè¶³" },
    ];

    const GENERIC_JOB_QUESTIONS = [
      {
        q: "é¢è©¦æ™‚æœ€é©åˆçš„è‡ªæˆ‘ä»‹ç´¹ç­–ç•¥æ˜¯ï¼Ÿ",
        options: ["èª‡å¤§è³‡æ­·è®“äººå°è±¡æ·±åˆ»", "ç”¨å…·é«”ä¾‹å­èªªæ˜èƒ½åŠ›èˆ‡æ…‹åº¦", "åªèªªè‡ªå·±å¾ˆç¼ºéŒ¢", "ä¸€ç›´æŠ±æ€¨å‰ä»½å·¥ä½œ"],
        answerIndex: 1
      },
      {
        q: "æ”¶åˆ°ã€Œå…ˆç¹³ä¿è­‰é‡‘æ‰å®‰æ’ä¸Šå·¥ã€çš„è¨Šæ¯ï¼Œæœ€ä½³åæ‡‰æ˜¯ï¼Ÿ",
        options: ["ç«‹åˆ»è½‰å¸³å¡ä½", "è©¢å•å°æ–¹èº«åˆ†è­‰ä¸¦æä¾›å¸³å¯†", "æé«˜è­¦è¦ºä¸¦æ‹’çµ•ä»˜æ¬¾ã€æ”¹èµ°æ­£å¼ç®¡é“", "è«‹å°æ–¹åŠ ä½ æ›´å¤šç¾¤çµ„"],
        answerIndex: 2
      },
      {
        q: "é‡åˆ°ä¸»ç®¡è‡¨æ™‚åŠ ç­è¦æ±‚ï¼Œè¼ƒå¥½çš„åšæ³•æ˜¯ï¼Ÿ",
        options: ["ç›´æ¥æ¶ˆå¤±ä¸å›è¨Šæ¯", "å…ˆç¢ºèªå…§å®¹èˆ‡æ™‚æ•¸ã€è©•ä¼°å¯è¡Œæ€§å†å›è¦†", "ç«‹åˆ»ç­”æ‡‰ä½†ä¹‹å¾Œä¸åˆ°", "å…¬é–‹æŠ±æ€¨åŒäº‹å¾ˆçˆ›"],
        answerIndex: 1
      },
      {
        q: "å·¥ä½œå®‰å…¨æœ€é‡è¦çš„åŸå‰‡æ˜¯ï¼Ÿ",
        options: ["è¶•å¿«åšå®Œæ¯”è¼ƒé‡è¦", "ä¸æ‡‚å°±ç¡¬åš", "éµå®ˆè¦ç¯„ã€å¿…è¦æ™‚è«‹æ•™ä¸¦é…æˆ´é˜²è­·", "çœ‹åˆ¥äººæ€éº¼åšå°±è·Ÿè‘—åš"],
        answerIndex: 2
      },
      {
        q: "é¢è©¦è¢«å•åˆ°ç©ºçª—æœŸï¼Œä½ å¯ä»¥æ€éº¼èªªè¼ƒåˆé©ï¼Ÿ",
        options: ["å®Œå…¨ä¸å›ç­”", "ç”¨å­¸ç¿’/ç…§é¡§/æº–å‚™æ–¹å‘ç°¡è¦èªªæ˜ä¸¦å›åˆ°è·å‹™åŒ¹é…", "æ€ªç½ªå‰é›‡ä¸»", "è¬›å¾ˆå¤šå…«å¦"],
        answerIndex: 1
      },
      {
        q: "è‹¥åŒäº‹é‚€ä½ ä¸€èµ·åšä¸åˆè¦çš„äº‹ï¼Œä½ æœ€å¥½çš„å›æ‡‰æ˜¯ï¼Ÿ",
        options: ["å…ˆåšå†èªª", "å©‰æ‹’ä¸¦å°‹æ±‚ä¸»ç®¡/è¦ç¯„ç¢ºèª", "æŠŠè²¬ä»»æ¨çµ¦åˆ¥äºº", "æ‹å½±ç‰‡ä¸Šç¶²å…¬å¯©"],
        answerIndex: 1
      },
    ];

    const JOBS = [
      {
        id: "flyer",
        title: "æ´¾å ±/å‚³å–®",
        wage: 190,
        energy: 10,
        mood: -2,
        minAge: 15,
        strictAge: false,
        apCost: 1,
        desc: "èµ°è·¯å¤šã€æ—¥æ›¬é›¨æ·‹ï¼Œé©åˆçŸ­æœŸå¿«é€Ÿè³ºã€‚",
        interviews: [
          { q: "é‡åˆ°è·¯äººæ‹’æ”¶å‚³å–®ï¼Œä½ æœƒæ€éº¼åšï¼Ÿ", options: ["ç¡¬å¡", "ç¦®è²Œé“è¬ã€æ”¹æ‰¾ä¸‹ä¸€ä½", "å—†å°æ–¹", "è·Ÿè¹¤å°æ–¹"], answerIndex: 1 },
          { q: "å·¥ä½œä¸­å¯ä»¥å¦‚ä½•ä¿è­·è‡ªå·±ï¼Ÿ", options: ["ç©¿æ‹–é‹", "è£œæ°´ã€é˜²æ›¬ã€æ³¨æ„äº¤é€š", "é‚Šèµ°é‚Šæ»‘æ‰‹æ©Ÿ", "é—–ç´…ç‡ˆçœæ™‚é–“"], answerIndex: 1 },
        ],
      },
      {
        id: "convenience",
        title: "è¶…å•†åº—å“¡",
        wage: 185,
        energy: 12,
        mood: 0,
        minAge: 16,
        strictAge: false,
        apCost: 1,
        desc: "å­¸ç¿’æ”¶éŠ€ã€è£œè²¨èˆ‡æœå‹™æµç¨‹ï¼Œç¯€å¥å¿«ã€‚",
        interviews: [
          { q: "æ‰¾é›¶æ™‚ç™¼ç¾é‡‘é¡ä¸ç¢ºå®šï¼Œä½ æœƒï¼Ÿ", options: ["éš¨ä¾¿çµ¦", "è«‹ä¸»ç®¡ç¢ºèªå†æ‰¾é›¶", "è®“å®¢äººè‡ªå·±ç®—", "å…ˆä¸‹ç­"], answerIndex: 1 },
          { q: "é‡åˆ°å®¢äººæƒ…ç·’æ¿€å‹•ï¼Œä½ æœƒï¼Ÿ", options: ["å›å—†", "ä¿æŒå†·éœã€å¿…è¦æ™‚è«‹åŒäº‹/ä¸»ç®¡å”åŠ©", "ç›´æ¥è·‘èµ°", "éŒ„å½±ä¸Šç¶²"], answerIndex: 1 },
        ],
      },
      {
        id: "construction",
        title: "å·¥åœ°æ¬é‹/æ‰“é›œ",
        wage: 220,
        energy: 18,
        mood: -3,
        minAge: 18,
        strictAge: true,
        apCost: 1,
        desc: "é«”åŠ›æ¶ˆè€—å¤§ã€æ³¨æ„å®‰å…¨è¦ç¯„ï¼Œè–ªè³‡è¼ƒé«˜ã€‚",
        interviews: [
          { q: "å·¥åœ°å®‰å…¨å¸½ç”¨é€”æ˜¯ï¼Ÿ", options: ["å¥½çœ‹", "é˜²æ­¢è½ç‰©/ç¢°æ’å‚·å®³", "æ‹¿ä¾†æ”¾é£²æ–™", "ä¸ç”¨æˆ´"], answerIndex: 1 },
          { q: "æ¬é‡ç‰©æœ€é‡è¦çš„å§¿å‹¢æ˜¯ï¼Ÿ", options: ["å½è…°ç¡¬æ‹‰", "ç”¨è…¿ç™¼åŠ›ã€ä¿æŒèƒŒéƒ¨ç©©å®š", "æ‰­è…°æ—‹è½‰", "è·‘æ­¥æ¬"], answerIndex: 1 },
        ],
      },
      {
        id: "tutor",
        title: "è£œç¿’ç­åŠ©æ•™",
        wage: 200,
        energy: 8,
        mood: 2,
        minAge: 16,
        strictAge: false,
        apCost: 1,
        desc: "éœ€è¦è€å¿ƒèˆ‡è¡¨é”ï¼Œå”åŠ©é»åèˆ‡ä½œæ¥­ã€‚",
        interviews: [
          { q: "å­¸ç”Ÿä¸€ç›´åˆ†å¿ƒï¼Œä½ æœƒï¼Ÿ", options: ["å¤§è²ç¾è¾±", "ç”¨ç°¡çŸ­æé†’èˆ‡å°ç›®æ¨™å¼•å°å›åˆ°ä»»å‹™", "æ”¾æ£„ä¸ç®¡", "æŠŠä»–è¶•å‡ºå»"], answerIndex: 1 },
          { q: "å®¶é•·è©¢å•å­©å­ç‹€æ³ï¼Œä½ æœƒï¼Ÿ", options: ["äº‚è¬›", "å¦‚å¯¦ã€ç°¡è¦ã€ä»¥äº‹å¯¦æè¿°ä¸¦è«‹ä¸»ç®¡è£œå……", "é€éœ²å…¶ä»–å­¸ç”Ÿéš±ç§", "å«å®¶é•·ä¸è¦ç®¡"], answerIndex: 1 },
        ],
      },
      {
        id: "restaurant",
        title: "é¤é£²å…§å¤–å ´",
        wage: 195,
        energy: 14,
        mood: -1,
        minAge: 16,
        strictAge: false,
        apCost: 1,
        desc: "å°–å³°å¿™ç¢Œï¼Œå­¸æœƒå”ä½œèˆ‡è¡›ç”Ÿæµç¨‹ã€‚",
        interviews: [
          { q: "æ‰‹éƒ¨è¡›ç”Ÿæœ€ä½³åŸå‰‡æ˜¯ï¼Ÿ", options: ["å¿™å°±ä¸ç”¨æ´—", "æ¥è§¸é£Ÿæå‰å¾Œéƒ½è¦æ´—æ‰‹", "åªæ´—ä¸€æ¬¡å°±å¥½", "æˆ´æ‰‹å¥—ä¸ç”¨æ´—"], answerIndex: 1 },
          { q: "é‡åˆ°å®¢è¨´ï¼Œä½ æœƒï¼Ÿ", options: ["è·Ÿå®¢äººåµ", "å…ˆè‡´æ„ã€è½å®Œéœ€æ±‚ã€å›å ±ä¸»ç®¡è™•ç†", "è£æ²’è½åˆ°", "æ€ªåŒäº‹"], answerIndex: 1 },
        ],
      },
      {
        id: "delivery",
        title: "å¤–é€åŠ©ç†ï¼ˆæ­¥è¡Œ/å–®è»Šï¼‰",
        wage: 180,
        energy: 16,
        mood: -2,
        minAge: 16,
        strictAge: false,
        apCost: 1,
        desc: "è·¯æ³å¤šè®Šï¼Œæ™‚é–“ç®¡ç†é‡è¦ã€‚",
        interviews: [
          { q: "æœ€å®¹æ˜“é€ æˆäº‹æ•…çš„è¡Œç‚ºæ˜¯ï¼Ÿ", options: ["éµå®ˆè™ŸèªŒ", "é‚Šé¨é‚Šæ»‘æ‰‹æ©Ÿ", "æ¸›é€Ÿé€šè¡Œ", "æˆ´å®‰å…¨å¸½"], answerIndex: 1 },
          { q: "é²åˆ°æ™‚ä½ æœƒï¼Ÿ", options: ["æ¶ˆå¤±", "ä¸»å‹•è¯ç¹«ä¸¦èªªæ˜é è¨ˆåˆ°é”æ™‚é–“", "æŠŠè²¬ä»»æ¨çµ¦å®¢äºº", "ä¸ŸåŒ…è£¹"], answerIndex: 1 },
        ],
      },
      {
        id: "tasting",
        title: "è©¦åƒ/ä¿ƒéŠ·",
        wage: 190,
        energy: 9,
        mood: 1,
        minAge: 15,
        strictAge: false,
        apCost: 1,
        desc: "éœ€è¦ä¸»å‹•ä½†ä¸æ‰“æ“¾ï¼Œå£æ¢æ¸…æ¥šåŠ åˆ†ã€‚",
        interviews: [
          { q: "é‚€è«‹è©¦åƒæ™‚è¼ƒä½³è©±è¡“æ˜¯ï¼Ÿ", options: ["ä½ ä¸€å®šè¦åƒ", "æ‚¨å¥½ï¼Œè¦ä¸è¦è©¦è©¦çœ‹ï¼Ÿä¸å‹‰å¼·", "ä¸åƒå°±èµ°", "åƒäº†è¦è²·"], answerIndex: 1 },
          { q: "é¡§å®¢å•ç”¢å“æˆåˆ†ä½ ä¸ç¢ºå®šï¼Œä½ æœƒï¼Ÿ", options: ["äº‚è¬›", "æŸ¥çœ‹æ¨™ç¤ºæˆ–è«‹ä¸»ç®¡ç¢ºèª", "ç›´æ¥èªªæˆ‘ä¸çŸ¥é“å°±èµ°", "å«ä»–è‡ªå·±æŸ¥"], answerIndex: 1 },
        ],
      },
      {
        id: "gas",
        title: "åŠ æ²¹ç«™æœå‹™",
        wage: 200,
        energy: 13,
        mood: 0,
        minAge: 16,
        strictAge: false,
        apCost: 1,
        desc: "æ³¨æ„å®‰å…¨èˆ‡ç¦®è²Œï¼Œéœ€éµå®ˆä½œæ¥­æµç¨‹ã€‚",
        interviews: [
          { q: "åŠ æ²¹æ™‚æœ€é‡è¦çš„å®‰å…¨è¦ç¯„ï¼Ÿ", options: ["æŠ½è¸ä¹Ÿå¯ä»¥", "ç¦æ­¢ä½¿ç”¨ç«æºã€ä¾æµç¨‹æ“ä½œ", "è·‘ä¾†è·‘å»", "ä¸ç”¨é—œå¼•æ“"], answerIndex: 1 },
          { q: "é‡åˆ°ä¸æ˜è¨­å‚™ç•°å¸¸ï¼Œä½ æœƒï¼Ÿ", options: ["è‡ªå·±äº‚ä¿®", "ç«‹åˆ»é€šå ±ä¸»ç®¡ä¸¦åœæ­¢æ“ä½œ", "ç•¶ä½œæ²’çœ‹åˆ°", "ç¹¼çºŒç¡¬åš"], answerIndex: 1 },
        ],
      },
    ];

    const HOUSING = [
      {
        id: "ccsa",
        tag: "ccsa",
        title: "CCSA è‡ªç«‹å®¿èˆ",
        rent: 0,
        deposit: 0,
        securityDelta: +8,
        desc: "æœ‰ç¤¾å·¥æ”¯æŒèˆ‡è¦ç¯„ï¼Œç”Ÿæ´»è¼ƒç©©å®šã€‚",
        quizKey: "ccsa_interview"
      },
      {
        id: "rooftop",
        tag: "rooftop",
        title: "é ‚åŠ é›…æˆ¿",
        rent: 4500,
        deposit: 9000,
        securityDelta: -6,
        desc: "ä¾¿å®œä½†å®‰å…¨é¢¨éšªè¼ƒé«˜ï¼Œæ¼æ°´/æ¶ˆé˜²è¦æ³¨æ„ã€‚",
        quizKey: "rule_check"
      },
      {
        id: "basement",
        tag: "basement",
        title: "åœ°ä¸‹å®¤å¥—æˆ¿",
        rent: 5200,
        deposit: 10400,
        securityDelta: -8,
        desc: "æ½®æ¿•ã€é€šé¢¨å·®ï¼Œé€ƒç”Ÿå‹•ç·šè¦ç¢ºèªã€‚",
        quizKey: "house_check"
      },
      {
        id: "shared",
        tag: "shared",
        title: "åˆç§Ÿå…¬å¯“ï¼ˆåˆ†ç§Ÿï¼‰",
        rent: 6000,
        deposit: 12000,
        securityDelta: -1,
        desc: "èˆ‡å®¤å‹å…±ç”¨ç©ºé–“ï¼Œå¥‘ç´„èˆ‡åˆ†æ”¤è¦è¬›æ¸…æ¥šã€‚",
        quizKey: "contract_check"
      },
      {
        id: "dorm",
        tag: "dorm",
        title: "é’å¹´æ—…å®¿é•·ä½",
        rent: 7000,
        deposit: 7000,
        securityDelta: 0,
        desc: "å½ˆæ€§é«˜ä½†è¦å®šå¤šï¼Œæ³¨æ„é–€ç¦èˆ‡æŠ¼é‡‘ã€‚",
        quizKey: "rule_check"
      },
      {
        id: "relative",
        tag: "relative",
        title: "è¦ªå‹å€Ÿä½",
        rent: 0,
        deposit: 0,
        securityDelta: +2,
        desc: "æˆæœ¬ä½ä½†äººéš›ç•Œç·šè¦æ¸…æ¥šï¼Œé¿å…è¡çªã€‚",
        quizKey: "relative_check"
      },
      {
        id: "coliving",
        tag: "coliving",
        title: "å…±å±…ç©ºé–“",
        rent: 8500,
        deposit: 8500,
        securityDelta: +1,
        desc: "å…¬å…±ç©ºé–“å¤šï¼Œé©åˆçµäº¤äººè„ˆä½†èŠ±è²»è¼ƒé«˜ã€‚",
        quizKey: "contract_check"
      },
      {
        id: "studio",
        tag: "studio",
        title: "å°å¥—æˆ¿ï¼ˆç¨ç«‹ï¼‰",
        rent: 12000,
        deposit: 24000,
        securityDelta: +2,
        desc: "éš±ç§å¥½ä½†æˆæœ¬é«˜ï¼Œéœ€è©•ä¼°è²¡å‹™èƒ½åŠ›ã€‚",
        quizKey: "contract_check"
      },
    ];

    const SHOP_ITEMS = [
      { id: "lunchbox", title: "ä¾¿ç•¶", price: 120, desc: "è£œå……é«”åŠ›ï¼Œå°ç¢ºå¹¸ã€‚", effects: { health: +5, mood: +2 }, ageMin: 0 },
      { id: "health_insurance", title: "å¥ä¿è£œç¹³/é†«ç™‚ä¿éšª", price: 600, desc: "é™ä½ç”Ÿç—…äº‹ä»¶æå¤±ï¼ˆé“å…·ï¼‰ã€‚", effects: { item: "health_insurance" }, ageMin: 0 },
      { id: "accident_insurance", title: "æ„å¤–éšª", price: 800, desc: "é™ä½æ„å¤–äº‹ä»¶æå¤±ï¼ˆé“å…·ï¼‰ã€‚", effects: { item: "accident_insurance" }, ageMin: 0 },
      { id: "b_vitamin", title: "Bç¾¤", price: 180, desc: "ç²¾ç¥ææŒ¯ï¼ŒçŸ­æœŸåŠ æˆã€‚", effects: { health: +3, mood: +3 }, ageMin: 0 },
      { id: "bubble_tea", title: "æ‰‹æ–é£²", price: 70, desc: "å¿ƒæƒ…ä¸Šå‡ä½†ä¸å®œå¤ªå¤šã€‚", effects: { mood: +5, health: -1 }, ageMin: 0 },
      { id: "new_clothes", title: "æ–°è¡£æœ", price: 900, desc: "é¢è©¦è‡ªä¿¡æå‡ã€‚", effects: { mood: +10, security: +2 }, ageMin: 0 },
      { id: "concert", title: "æ¼”å”±æœƒ", price: 2500, desc: "å¤§å¿«æ¨‚ï¼Œä½†è¦æ³¨æ„é ç®—ã€‚", effects: { mood: +25, health: -3 }, ageMin: 0 },
      { id: "iphone", title: "iPhoneï¼ˆåˆ†æœŸèª˜æƒ‘ï¼‰", price: 24000, desc: "å¾ˆæƒ³è¦ï¼Œä½†è²¡å‹™å£“åŠ›å¤§ã€‚", effects: { mood: +12, security: -2 }, ageMin: 0 },
      { id: "stock_scam", title: "é£†è‚¡å…§ç·šç¾¤ï¼ˆè©é¨™ï¼‰", price: 3000, desc: "çœ‹ä¼¼å¿«é€Ÿè‡´å¯Œï¼Œå…¶å¯¦æ˜¯é™·é˜±ã€‚", scam: true, effects: { mood: -30, security: -5 }, ageMin: 0 },
    ];

    const QUIZ_DB = {
      house_check: [
        { q: "çœ‹æˆ¿æ™‚æ‡‰å„ªå…ˆç¢ºèªå“ªä¸€é …ï¼Ÿ", options: ["æˆ¿æ±æ˜Ÿåº§", "é€ƒç”Ÿå‹•ç·šèˆ‡æ¶ˆé˜²è¨­å‚™", "ç‰†å£é¡è‰²", "é„°å±…å…«å¦"], answerIndex: 1 },
        { q: "ç™¼ç¾ç‰†è§’åš´é‡ç™¼éœ‰ï¼Œä½ æ‡‰è©²ï¼Ÿ", options: ["ç•¶ä½œæ²’çœ‹åˆ°", "æ‹ç…§è¨˜éŒ„ä¸¦è©¢å•æ”¹å–„/è€ƒæ…®ä¸ç§Ÿ", "ç«‹åˆ»ç°½ç´„", "è‡ªå·±ç²‰åˆ·"], answerIndex: 1 },
        { q: "çœ‹æˆ¿æ™‚å¸¶æœ‹å‹/ç¤¾å·¥é™ªåŒçš„å¥½è™•æ˜¯ï¼Ÿ", options: ["åµæ¶æ¯”è¼ƒç†±é¬§", "å¤šä¸€é›™çœ¼ç›æª¢æŸ¥é¢¨éšª", "å¯ä»¥å¹«ä½ äº‚ç åƒ¹", "è®“æˆ¿æ±ç”Ÿæ°£"], answerIndex: 1 },
        { q: "ç§Ÿå±‹å¸¸è¦‹è©é¨™ç‰¹å¾µæ˜¯ï¼Ÿ", options: ["å¯ç¾å ´çœ‹æˆ¿", "è¦æ±‚å…ˆåŒ¯è¨‚é‡‘æ‰çµ¦åœ°å€", "åˆç´„æ¸…æ¥š", "æä¾›æˆ¿æ±è­‰æ˜"], answerIndex: 1 },
        { q: "é–€é–è€èˆŠåˆé¬†å‹•ï¼Œè¼ƒå¥½çš„åšæ³•æ˜¯ï¼Ÿ", options: ["ç®—äº†", "è¦æ±‚æ›´æ›æˆ–è‡ªè¡Œè©•ä¼°å®‰å…¨", "æŠŠé–€æ‹†æ‰", "æ™šä¸Šä¸å›å®¶"], answerIndex: 1 },
      ],
      contract_check: [
        { q: "ç°½ç´„å‰æœ€é‡è¦çš„æ˜¯ï¼Ÿ", options: ["åªçœ‹ç§Ÿé‡‘", "ç¢ºèªåˆç´„æ¢æ¬¾èˆ‡æŠ¼é‡‘/é€€ç§Ÿè¦å‰‡", "ç›¸ä¿¡å£é ­æ‰¿è«¾", "ä¸çœ‹å°±ç°½"], answerIndex: 1 },
        { q: "æŠ¼é‡‘çš„ç”¨é€”ä¸»è¦æ˜¯ï¼Ÿ", options: ["æˆ¿æ±è³ºéŒ¢", "ä¿éšœæˆ¿æ±æå®³èˆ‡æ¬ æ¬¾é¢¨éšªï¼ˆéœ€ä¾ç´„é€€é‚„ï¼‰", "ä¸ç”¨é€€", "æ‹¿å»æŠ•è³‡"], answerIndex: 1 },
        { q: "åˆç§Ÿåˆ†æ”¤æ°´é›»è²»ï¼Œè¼ƒä½³æ–¹å¼ï¼Ÿ", options: ["ç”¨çŒœçš„", "æ˜è¨‚åˆ†æ”¤æ–¹å¼ä¸¦ä¿ç•™å¸³å–®", "èª°æœ€æœ‰éŒ¢èª°ä»˜", "éƒ½ä¸ä»˜"], answerIndex: 1 },
        { q: "åˆç´„ä¸Šæ²’æœ‰ä½ çš„åå­—æœƒï¼Ÿ", options: ["æ²’å·®", "æ¬Šç›Šä¸æ˜ç¢ºï¼Œå¿…è¦æ™‚è¦æ±‚è£œç™»æˆ–ä¸ç§Ÿ", "æ›´å®‰å…¨", "å¯éš¨ä¾¿ä½"], answerIndex: 1 },
        { q: "è‹¥æˆ¿æ±æ‹’çµ•æä¾›æ”¶æ“š/å¥‘ç´„å‰¯æœ¬ï¼Ÿ", options: ["ç…§æ¨£ç§Ÿ", "æé«˜è­¦è¦ºï¼Œå¯èƒ½æœ‰é¢¨éšª", "çµ¦æ›´å¤šæŠ¼é‡‘", "æŠŠéŒ¢ä¸Ÿä¸‹å°±èµ°"], answerIndex: 1 },
      ],
      rule_check: [
        { q: "æ¶ˆé˜²å®‰å…¨æœ€åŸºæœ¬çš„åŸå‰‡ï¼Ÿ", options: ["æŠŠå‡ºå£å †æ»¿", "ä¿æŒèµ°é“èˆ‡å‡ºå£æš¢é€š", "ç”¨æ£‰è¢«å µé–€ç¸«", "åªçœ‹ç§Ÿé‡‘"], answerIndex: 1 },
        { q: "é ‚åŠ /åˆ†ç§Ÿå¸¸è¦‹é¢¨éšªæ˜¯ï¼Ÿ", options: ["å¤ªä¹¾æ·¨", "æ¼æ°´ã€é•å»ºã€é€ƒç”Ÿå›°é›£", "æ°´é›»å¤ªä¾¿å®œ", "ç¶²è·¯å¤ªå¿«"], answerIndex: 1 },
        { q: "é‡åˆ°å®¤å‹ä½œæ¯å·®ç•°å¤§ï¼Œè¼ƒä½³åšæ³•ï¼Ÿ", options: ["åµæ¶åˆ°åº•", "å…ˆå”å•†è¦å‰‡èˆ‡ç•Œç·šï¼ˆå®‰éœæ™‚é–“/æ¸…æ½”ï¼‰", "é»˜é»˜å¿åˆ°çˆ†ç‚¸", "å·æ›é–€é–"], answerIndex: 1 },
        { q: "åŠå¤œè½åˆ°ç“¦æ–¯å‘³ï¼Œä½ æ‡‰å…ˆï¼Ÿ", options: ["é»ç«ç¢ºèª", "é—œç“¦æ–¯ã€é–‹çª—ã€é¿å…é›»å™¨ç«èŠ±ä¸¦æ±‚åŠ©", "ç¡è¦º", "é»é¦™æ°›"], answerIndex: 1 },
        { q: "é–€ç¦è¦å‰‡ä¸æ¸…ï¼Œè¼ƒå¥½çš„è™•ç†ï¼Ÿ", options: ["ç®—äº†", "ç¢ºèªé–€ç¦èˆ‡è¨ªå®¢è¦ç¯„ï¼Œé¿å…è¡çª", "æ¯å¤©ç ´é–€", "æŠŠé–€ç¦å¡ä¸Ÿäº†"], answerIndex: 1 },
      ],
      relative_check: [
        { q: "è¦ªå‹å€Ÿä½æœ€éœ€è¦å…ˆè¬›æ¸…æ¥šçš„æ˜¯ï¼Ÿ", options: ["èª°æ¯”è¼ƒå¸¥", "ç•Œç·šèˆ‡åˆ†å·¥ï¼ˆè²»ç”¨/ä½œæ¯/æœŸé™ï¼‰", "ä»¥å¾Œèª°é¤Šèª°", "ä¸è¦è«‡"], answerIndex: 1 },
        { q: "è‹¥å°æ–¹çªç„¶è¦æ±‚ä½ ä»˜å¤§é‡è²»ç”¨ï¼Œä½ æ‡‰ï¼Ÿ", options: ["ç«‹åˆ»ç­”æ‡‰", "å…ˆé‡æ¸…æ˜ç´°ä¸¦è©•ä¼°å¯è¡Œã€å¿…è¦æ™‚æ±‚åŠ©", "å€Ÿé«˜åˆ©è²¸", "è£æ²’è½åˆ°"], answerIndex: 1 },
        { q: "äººéš›è¡çªå‡é«˜æ™‚ï¼Œè¼ƒå¥½çš„åšæ³•ï¼Ÿ", options: ["ç ¸æ±è¥¿", "æš«åœå°è©±ã€å†·éœå¾Œå†è«‡æˆ–æ‰¾ç¬¬ä¸‰æ–¹å”åŠ©", "å¨è„…å°æ–¹", "ç›´æ¥å¤±è¹¤"], answerIndex: 1 },
        { q: "å€Ÿä½è‹¥é€ æˆå£“åŠ›ï¼Œè¼ƒä½³ç­–ç•¥ï¼Ÿ", options: ["ç¡¬æ’", "è¨­å®šæœŸé™ä¸¦åŒæ­¥æ‰¾æ­£å¼å±…ä½æ–¹æ¡ˆ", "ä¸€ç›´æ‹–", "æŠŠè²¬ä»»æ¨çµ¦å°æ–¹"], answerIndex: 1 },
        { q: "å€Ÿä½æœŸé–“ä½ çš„é‡è¦æ–‡ä»¶æ‡‰ï¼Ÿ", options: ["äº‚ä¸Ÿ", "å¦¥å–„ä¿ç®¡èˆ‡å‚™ä»½", "å€Ÿçµ¦åˆ¥äºº", "æ”¾é–€å£"], answerIndex: 1 },
      ],
      ccsa_interview: [
        { q: "CCSA è‡ªç«‹å®¿èˆçš„æ ¸å¿ƒåƒ¹å€¼è¼ƒæ¥è¿‘ï¼Ÿ", options: ["æ”¾ä»»è‡ªç”±", "æ”¯æŒèˆ‡è¦ç¯„ä¸¦è¡Œã€æå‡è‡ªç«‹èƒ½åŠ›", "åªè¦ç¹³éŒ¢å°±å¥½", "äº’ç›¸æ¯”è¼ƒ"], answerIndex: 1 },
        { q: "è‹¥é‡åˆ°ç”Ÿæ´»è¦ç¯„ä¸é©æ‡‰ï¼Œä½ å¯ä»¥ï¼Ÿ", options: ["ç›´æ¥çˆ†ç‚¸", "å’Œç¤¾å·¥è¨è«–èª¿æ•´ç­–ç•¥èˆ‡æ”¯æŒ", "é€ƒè·‘ä¸å›ä¾†", "åœ¨ç¾¤çµ„ç½µäºº"], answerIndex: 1 },
        { q: "å®‰å…¨èˆ‡éš±ç§çš„åŸå‰‡æ˜¯ï¼Ÿ", options: ["é–€æ°¸é ä¸é–", "éµå®ˆé–€ç¦/ä¸å¤–æµä»–äººè³‡è¨Š", "æŠŠå®¤å‹ç§˜å¯†å…¬é–‹", "éš¨æ„å€Ÿé–€ç¦å¡"], answerIndex: 1 },
        { q: "è‹¥éœ€è¦å”åŠ©è³‡æºé€£çµï¼Œä½ æœƒï¼Ÿ", options: ["è‡ªå·±æ‰›", "ä¸»å‹•æå‡ºéœ€æ±‚ä¸¦å…±åŒæ“¬å®šè¨ˆç•«", "ç­‰åˆ¥äººä¾†æ•‘", "å»è³­ä¸€æŠŠ"], answerIndex: 1 },
        { q: "ä½é€²å®¿èˆå¾Œæœ€é‡è¦çš„ç¿’æ…£ä¹‹ä¸€æ˜¯ï¼Ÿ", options: ["æ¯å¤©ç†¬å¤œ", "è¨˜å¸³èˆ‡è¦åŠƒæ”¯å‡º", "æŠŠéŒ¢å€Ÿå…‰", "ä¸åšä»»ä½•ç´€éŒ„"], answerIndex: 1 },
      ],
      job_test: [
        { q: "çœ‹åˆ°å·¥ä½œç¾¤çµ„è¦æ±‚æä¾›éŠ€è¡Œå¸³å¯†ï¼Œä½ æ‡‰ï¼Ÿ", options: ["æä¾›æ¯”è¼ƒå¿«", "æ‹’çµ•ä¸¦æª¢èˆ‰/å°é–", "æŠŠå¯†ç¢¼æ”¹æˆ123", "è«‹æœ‹å‹å¹«ä½ çµ¦"], answerIndex: 1 },
        { q: "è–ªè³‡åŒ¯æ¬¾å‰è¦å…ˆä»˜ã€Œæ‰‹çºŒè²»ã€æ˜¯ï¼Ÿ", options: ["æ­£å¸¸", "é«˜é¢¨éšªè©é¨™è¨Šè™Ÿ", "å¾ˆä¾¿å®œå°±ä»˜", "å¯ä»¥è©¦è©¦"], answerIndex: 1 },
        { q: "é¢è©¦åœ°é»è‡¨æ™‚æ”¹åˆ°ååƒ»è™•ä¸”ä¸æä¾›å…¬å¸è³‡è¨Šï¼Œä½ æ‡‰ï¼Ÿ", options: ["ç«‹åˆ»å‰å¾€", "æé«˜è­¦è¦ºï¼Œæ”¹åœ¨å…¬é–‹å ´æ‰€/å–æ¶ˆ", "å¸¶å¾ˆå¤šç¾é‡‘", "é—œæ‰å®šä½"], answerIndex: 1 },
        { q: "åŒäº‹è¦æ±‚ä½ ä»£æ”¶æ¬¾é …å†è½‰å‡ºï¼Œä½ æ‡‰ï¼Ÿ", options: ["å¹«å¿™å°±å¥½", "æ‹’çµ•ï¼Œå¯èƒ½æ¶‰åŠæ´—éŒ¢", "å¤šæ”¶ä¸€é»ç•¶ä½£é‡‘", "ç”¨åˆ¥äººå¸³æˆ¶è½‰"], answerIndex: 1 },
        { q: "é‡åˆ°ä¸åˆç†è¦æ±‚ï¼Œæœ€å¥½çš„åšæ³•ï¼Ÿ", options: ["å¿è€", "ä¿ç•™è­‰æ“šä¸¦å°‹æ±‚ä¸»ç®¡/æ­£å¼ç®¡é“å”åŠ©", "ç›´æ¥å‹•æ‰‹", "ä¸Šç¶²å—†äºº"], answerIndex: 1 },
      ],
      welfare_help: [
        { q: "å‘ç¦åˆ©ä¸­å¿ƒæ±‚åŠ©æ™‚ï¼Œè¼ƒå¥½çš„æº–å‚™æ˜¯ï¼Ÿ", options: ["ç©ºæ‰‹å»", "æ•´ç†éœ€æ±‚ã€æ”¶å…¥æ”¯å‡ºèˆ‡è­‰æ˜æ–‡ä»¶", "åªèªªå¾ˆæ…˜", "ä¸éœ€è¦èªªæ˜"], answerIndex: 1 },
        { q: "ç¤¾ç¦è³‡æºçš„åŸå‰‡è¼ƒæ¥è¿‘ï¼Ÿ", options: ["æƒ³æ‹¿å°±æ‹¿", "ä¾éœ€æ±‚è©•ä¼°ã€é™ªä¼´è‡ªç«‹", "åªçœ‹é—œä¿‚", "å®Œå…¨ä¸ç”¨é…åˆ"], answerIndex: 1 },
        { q: "å¦‚æœä½ ä¸ç¢ºå®šæ€éº¼è¡¨é”éœ€æ±‚ï¼Œä½ å¯ä»¥ï¼Ÿ", options: ["æ”¾æ£„", "è«‹ç¤¾å·¥å”åŠ©é‡æ¸…èˆ‡åˆ—å‡ºå„ªå…ˆé †åº", "äº‚å¯«", "è²¬æ€ªåˆ¥äºº"], answerIndex: 1 },
      ],
      finance_help: [
        { q: "ç”³è«‹æ€¥é›£æ•‘åŠ©æ™‚ï¼Œæœ€é‡è¦çš„æ˜¯ï¼Ÿ", options: ["éš±çç‹€æ³", "èª å¯¦æä¾›ç¾æ³ä¸¦é…åˆå¯©æ ¸", "ä¸€ç›´å‚¬ä¿ƒ", "äº¤å‡è³‡æ–™"], answerIndex: 1 },
        { q: "æ‹¿åˆ°è£œåŠ©æœ€å»ºè­°å…ˆåšï¼Ÿ", options: ["å…¨éƒ¨èŠ±å…‰", "å…ˆè£œåŸºæœ¬ç”Ÿæ´»èˆ‡å¿…è¦æ”¯å‡ºã€ä¿ç•™é å‚™é‡‘", "å€Ÿæœ‹å‹", "è²·å¥¢ä¾ˆå“"], answerIndex: 1 },
        { q: "è‹¥è¢«è¦æ±‚æä¾›ææ¬¾å¡èˆ‡å¯†ç¢¼æ›å–è£œåŠ©ï¼Ÿ", options: ["æä¾›", "æ‹’çµ•ï¼Œé€™æ˜¯è©é¨™", "å…ˆæä¾›å†èªª", "å•æœ‹å‹è¦ä¸è¦ä¸€èµ·"], answerIndex: 1 },
      ],
    };

    const SCENARIOS = {
      friend_loan: {
        id: "friend_loan",
        title: "æœ‹å‹å€ŸéŒ¢",
        body: "æœ‹å‹èªªè‡¨æ™‚å‘¨è½‰ï¼Œæƒ³è·Ÿä½ å€Ÿä¸€ç­†éŒ¢ï¼Œä¸¦ä¿è­‰ä¸‹é€±å°±é‚„ã€‚ä½ æ€éº¼è¾¦ï¼Ÿ",
        choices: [
          { label: "å€Ÿä»– 1000 å…ƒ", effect: (ctx)=> {
              const can = ctx.money >= 1000;
              if(!can){
                return { deltas: { mood: -6 }, log: "ğŸ¤ æƒ³å€Ÿä½†éŒ¢ä¸å¤ ï¼Œå¿ƒæƒ…æœ‰é»æ²®å–ªã€‚" };
              }
              return { deltas: { money: -1000, mood: -2 }, log: "ğŸ¤ å€Ÿå‡º 1000 å…ƒï¼Œè¨˜å¾—ç•™å­˜ç´€éŒ„èˆ‡ç•Œç·šã€‚" };
            }
          },
          { label: "å©‰æ‹’ä¸¦èªªæ˜ä½ ä¹Ÿåœ¨è‡ªç«‹", effect: (ctx)=> ({ deltas: { mood: +2, security: +1 }, log: "âœ… ä½ å©‰æ‹’å€ŸéŒ¢ï¼Œä¿è­·è‡ªå·±çš„ç”Ÿæ´»ç©©å®šã€‚" }) },
          { label: "æè­°ä¸€èµ·æ‰¾åˆæ³•è³‡æº/ç¦åˆ©å”åŠ©", effect: (ctx)=> ({ deltas: { mood: +4, security: +2 }, log: "ğŸ§­ ä½ æä¾›æ›¿ä»£æ–¹æ¡ˆï¼šå¼•å°å°æ–¹èµ°è³‡æºç®¡é“ã€‚" }) },
        ],
      },
      scam_romance: {
        id: "scam_romance",
        title: "ç¶²è·¯æˆ€æ„›è©é¨™",
        body: "ä½ èªè­˜çš„ç¶²å‹çªç„¶å¾ˆç”œï¼Œèªªè¦æŠ•è³‡è³ºéŒ¢ä¸€èµ·æ—…è¡Œï¼Œè«‹ä½ å…ˆåŒ¯ä¸€ç­†ã€ä¿è­‰é‡‘ã€ã€‚",
        choices: [
          { label: "å…ˆåŒ¯ 2000 å…ƒè©¦è©¦", effect: (ctx)=> {
              if(ctx.security >= 60){
                return { deltas: { mood: -3, security: +2 }, log: "âš ï¸ ä½ è¦ºå¾—æ€ªæ€ªçš„åœä¸‹ä¾†ï¼Œé¿å…è½‰å¸³ã€‚" , override: { preventPayment: true } };
              }
              if(ctx.money < 2000){
                return { deltas: { mood: -10 }, log: "ğŸ’” æƒ³åŒ¯ä½†éŒ¢ä¸å¤ ï¼Œå°æ–¹é–‹å§‹æƒ…ç·’å‹’ç´¢ã€‚" };
              }
              return { deltas: { money: -2000, mood: -18, security: -6 }, log: "ğŸš« ä½ è¢«è©é¨™è½‰èµ° 2000 å…ƒï¼Œå¿ƒæƒ…å¤§å—æ‰“æ“Šã€‚" };
            } },
          { label: "ä¸è½‰å¸³ã€å°é–ä¸¦æª¢èˆ‰", effect: (ctx)=> ({ deltas: { mood: +3, security: +4 }, log: "âœ… ä½ æ‹’çµ•è½‰å¸³ä¸¦å°é–ï¼Œè³‡å®‰æ„è­˜æå‡ã€‚" }) },
          { label: "æ‰¾ç¤¾å·¥/å¯ä¿¡ä»»å¤§äººè¨è«–", effect: (ctx)=> ({ deltas: { mood: +4, security: +3 }, log: "ğŸ§© ä½ å°‹æ±‚å”åŠ©ï¼Œé¿å…è½å…¥æƒ…ç·’å‹’ç´¢ã€‚" }) },
        ],
      },
      scam_job: {
        id: "scam_job",
        title: "å‡å¾µæ‰è©é¨™",
        body: "çœ‹åˆ°é«˜è–ªå…¼è·ï¼šã€æ‰“å­—å³å¯æ—¥é ˜ã€ã€‚å°æ–¹è¦æ±‚å…ˆä»˜ã€æ•™æè²»ã€ä¸¦æä¾›éŠ€è¡Œè³‡æ–™ã€‚",
        choices: [
          { label: "ç…§åšï¼ˆä»˜ 1500ï¼‰", effect: (ctx)=> {
              if(ctx.security >= 65){
                return { deltas: { mood: -2, security: +2 }, log: "âš ï¸ ä½ å¯Ÿè¦ºä¸å°åœæ­¢ä»˜æ¬¾ï¼Œé€ƒéä¸€åŠ«ã€‚", override: { preventPayment: true } };
              }
              if(ctx.money < 1500){
                return { deltas: { mood: -8 }, log: "ğŸ˜£ æƒ³ä»˜ä½†éŒ¢ä¸å¤ ï¼Œå°æ–¹ä¸€ç›´å‚¬ä¿ƒã€‚" };
              }
              return { deltas: { money: -1500, mood: -15, security: -8 }, log: "ğŸš« ä½ ä»˜äº†æ•™æè²»å¾Œè¢«å°é–ï¼Œæå¤± 1500 å…ƒã€‚" };
            } },
          { label: "æ‹’çµ•ä»˜æ¬¾ä¸¦ä¿ç•™è­‰æ“š", effect: (ctx)=> ({ deltas: { security: +4, mood: +2 }, log: "âœ… ä½ æ‹’çµ•ä¸¦ä¿å­˜å°è©±ï¼Œè³‡å®‰æå‡ã€‚" }) },
          { label: "æ”¹èµ°äººåŠ›éŠ€è¡Œ/å…¬éƒ¨é–€å°±æœç«™", effect: (ctx)=> ({ deltas: { mood: +3, security: +3 }, log: "ğŸ§­ ä½ é¸æ“‡æ­£è¦ç®¡é“ï¼Œé™ä½é¢¨éšªã€‚" }) },
        ],
      },
      accident: {
        id: "accident",
        title: "å°æ„å¤–",
        body: "ä½ åœ¨è·¯ä¸Šä¸å°å¿ƒæ»‘å€’æ“¦å‚·ï¼Œéœ€è¦çœ‹é†«ç”Ÿèˆ‡ä¼‘é¤Šã€‚",
        choices: [
          { label: "å»å°±é†«", effect: (ctx)=> {
              const hasAcc = ctx.items.includes("accident_insurance");
              if(hasAcc){
                return { deltas: { health: -6, money: -200, mood: -2 }, log: "ğŸ©¹ æœ‰æ„å¤–éšªï¼Œé†«ç™‚æ”¯å‡ºè¼ƒä½ï¼ˆ-200ï¼‰ã€‚" };
              }
              return { deltas: { health: -18, money: -1200, mood: -6 }, log: "ğŸ©¹ æ²’æœ‰ä¿éšªï¼Œé†«ç™‚æ”¯å‡ºè¼ƒé«˜ï¼ˆ-1200ï¼‰ã€‚" };
            } },
          { label: "å…ˆæ“¦è—¥ä¼‘æ¯", effect: (ctx)=> ({ deltas: { health: -10, mood: -3 }, log: "ğŸ©¹ ä½ å…ˆè‡ªè¡Œè™•ç†ï¼Œä½†æ¢å¾©è¼ƒæ…¢ã€‚" }) },
        ],
      },
      sickness: {
        id: "sickness",
        title: "èº«é«”ä¸é©",
        body: "ä½ çªç„¶æ„Ÿå†’æˆ–è…¸èƒƒä¸é©ï¼Œå½±éŸ¿é«”åŠ›èˆ‡å¿ƒæƒ…ã€‚",
        choices: [
          { label: "çœ‹é†«ç”Ÿä¸¦ä¼‘æ¯", effect: (ctx)=> {
              const hasH = ctx.items.includes("health_insurance");
              if(hasH){
                return { deltas: { health: -5, money: -150, mood: -1 }, log: "ğŸ’Š æœ‰é†«ç™‚ä¿éšª/å¥ä¿è£œç¹³ï¼Œè² æ“”è¼ƒä½ï¼ˆ-150ï¼‰ã€‚" };
              }
              return { deltas: { health: -16, money: -900, mood: -5 }, log: "ğŸ’Š æ²’æœ‰ä¿éšªï¼ŒèŠ±è²»è¼ƒé«˜ï¼ˆ-900ï¼‰ã€‚" };
            } },
          { label: "æ’ä¸€ä¸‹", effect: (ctx)=> ({ deltas: { health: -14, mood: -6 }, log: "ğŸ¤’ ä½ ç¡¬æ’ï¼Œç‹€æ³æ›´ç–²æ†Šã€‚" }) },
        ],
      },
      police: {
        id: "police",
        title: "è‡¨æª¢/é—œæ‡·è¨ªè¦–",
        body: "ä½ åœ¨è¡—é ­è¢«è­¦æ–¹é—œæ‡·è©¢å•èº«åˆ†èˆ‡å»å‘ã€‚ä½ æ€éº¼æ‡‰å°ï¼Ÿ",
        choices: [
          { label: "ç¦®è²Œé…åˆ", effect: (ctx)=> {
              const hasGood = ctx.items.includes("good_citizen_card");
              if(ctx.age >= 18 && hasGood){
                return { deltas: { mood: +5, security: +3, ap: +1 }, log: "ğŸ‘® ä½ æ…‹åº¦è‰¯å¥½ä¸”æœ‰è‰¯æ°‘å¡ï¼Œäº’å‹•é †åˆ©ï¼ˆAP+1ï¼‰ã€‚" };
              }
              if(ctx.age >= 18 && !hasGood){
                return { deltas: { mood: -3, security: +1, ap: -1 }, log: "ğŸ‘® ä½ é…åˆå®Œæˆï¼Œä½†è€½èª¤æ™‚é–“ï¼ˆAP-1ï¼‰ã€‚" };
              }
              return { deltas: { mood: -8, security: -2 }, log: "ğŸ‘® æœªæ»¿18ï¼Œè­¦æ–¹æé†’éœ€æ›´æ³¨æ„å®‰å…¨èˆ‡è¡Œç¨‹ï¼ˆå¿ƒæƒ…-8ï¼‰ã€‚" };
            } },
          { label: "æ…‹åº¦å¼·ç¡¬å›å—†", effect: (ctx)=> ({ deltas: { mood: -12, security: -4, ap: -1 }, log: "ğŸš« ä½ æ…‹åº¦ä¸ä½³ï¼Œäº’å‹•ç·Šå¼µï¼Œå½±éŸ¿å¿ƒæƒ…èˆ‡è³‡å®‰ã€‚" }) },
        ],
      },
    };

    /********************
     * Utilities
     ********************/
    function clamp(n, min, max){ return Math.max(min, Math.min(max, n)); }

    function shuffleArray(arr){
      const a = Array.isArray(arr) ? arr.slice() : [];
      for(let i=a.length-1; i>0; i--){
        const j = Math.floor(Math.random()*(i+1));
        [a[i], a[j]] = [a[j], a[i]];
      }
      return a;
    }

    function weightedPick(items){
      const total = items.reduce((s,it)=> s + (it.w || 0), 0);
      let r = Math.random() * total;
      for(const it of items){
        r -= (it.w || 0);
        if(r <= 0) return it.id;
      }
      return items.length ? items[items.length-1].id : null;
    }

    function pickOrigin(){
      const roll = Math.random();
      let cum = 0;
      for(const o of CHARACTER_ORIGINS){
        cum += o.prob;
        if(roll <= cum) return o;
      }
      return CHARACTER_ORIGINS[CHARACTER_ORIGINS.length-1];
    }

    /********************
     * Icons (å…§å»º SVG React Components)
     ********************/
    function IconWrapper({ children, className="" }){
      return (
        <svg viewBox="0 0 24 24" className={"w-8 h-8 " + className} fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
          {children}
        </svg>
      );
    }
    function IconHome(){ return <IconWrapper><path d="M3 10.5L12 3l9 7.5"/><path d="M5 10v10h14V10"/></IconWrapper>; }
    function IconHouse(){ return <IconWrapper><path d="M3 11l9-8 9 8"/><path d="M5 10v10h14V10"/><path d="M9 20v-6h6v6"/></IconWrapper>; }
    function IconBriefcase(){ return <IconWrapper><path d="M9 6V5a2 2 0 0 1 2-2h2a2 2 0 0 1 2 2v1"/><path d="M3 9h18v10a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V9z"/><path d="M3 13h18"/></IconWrapper>; }
    function IconMap(){ return <IconWrapper><path d="M9 18l-6 3V6l6-3 6 3 6-3v15l-6 3-6-3z"/><path d="M9 3v15"/><path d="M15 6v15"/></IconWrapper>; }
    function IconWallet(){ return <IconWrapper><path d="M3 7h18v12H3z"/><path d="M3 7l2-3h16v3"/><path d="M16 13h5"/><circle cx="16" cy="13" r="1"/></IconWrapper>; }
    function IconLock(){ return <IconWrapper><rect x="5" y="11" width="14" height="10" rx="2"/><path d="M8 11V8a4 4 0 0 1 8 0v3"/></IconWrapper>; }
    function IconArrowLeft(){ return <IconWrapper><path d="M15 18l-6-6 6-6"/><path d="M9 12h12"/></IconWrapper>; }
    function IconShop(){ return <IconWrapper><path d="M6 2l1 5h10l1-5"/><path d="M5 7h14l-1 14H6L5 7z"/><path d="M9 11v6"/><path d="M15 11v6"/></IconWrapper>; }
    function IconInfo(){ return <IconWrapper><circle cx="12" cy="12" r="10"/><path d="M12 16v-4"/><path d="M12 8h.01"/></IconWrapper>; }

    /********************
     * UI Components
     ********************/
    function SmallBadge({ text, tone="bg-black text-white" }){
      return (
        <span className={"px-2 py-1 rounded-full text-[11px] font-bold border-2 border-black " + tone}>
          {text}
        </span>
      );
    }

    function StatPill({ label, value, barClass="bg-emerald-300" }){
      return (
        <div className="neo-soft p-2">
          <div className="flex items-center justify-between">
            <div className="font-pixel text-3xl leading-none">{label}</div>
            <div className="font-pixel text-3xl leading-none">{value}</div>
          </div>
          <div className="mt-2 h-3 border-2 border-black rounded-full overflow-hidden bg-white">
            <div className={"h-full " + barClass} style={{ width: clamp(value,0,100) + "%" }}></div>
          </div>
        </div>
      );
    }

    function APBoxes({ ap, maxAp }){
      const boxes = [];
      for(let i=0; i<maxAp; i++){
        const filled = i < ap;
        boxes.push(
          <div key={i} className={"w-4 h-4 border-2 border-black " + (filled ? "bg-black" : "bg-white")}></div>
        );
      }
      return <div className="flex gap-1">{boxes}</div>;
    }

    function StatBar({ week, maxWeeks, health, mood, security, ap, maxAp, livingCost }){
      return (
        <div className="p-3 bg-white border-b-2 border-black">
          <div className="flex items-center justify-between gap-3">
            <div className="font-pixel text-3xl leading-none">
              Week {week}/{maxWeeks} <span className="text-sm font-semibold font-sans ml-2">(æœ¬é€±åŸºæœ¬æ”¯å‡º: {livingCost})</span>
            </div>
            <div className="flex items-center gap-2">
              <div className="font-pixel text-3xl leading-none">AP</div>
              <APBoxes ap={ap} maxAp={maxAp} />
            </div>
          </div>
          <div className="mt-3 grid grid-cols-3 gap-2">
            <StatPill label="é«”åŠ›" value={health} barClass="bg-emerald-300" />
            <StatPill label="å¿ƒæƒ…" value={mood} barClass="bg-yellow-300" />
            <StatPill label="è³‡å®‰" value={security} barClass="bg-sky-300" />
          </div>
        </div>
      );
    }

    function AppIcon({ title, subtitle, onClick, Icon, tone="bg-white" }){
      return (
        <button onClick={onClick} className={"neo-btn neo-card w-full p-3 text-left " + tone}>
          <div className="flex items-center gap-3">
            <div className="w-12 h-12 border-2 border-black rounded-2xl flex items-center justify-center bg-white">
              <div className="text-black">{Icon}</div>
            </div>
            <div className="flex-1">
              <div className="font-pixel text-4xl leading-none">{title}</div>
              <div className="text-xs font-semibold text-gray-700">{subtitle}</div>
            </div>
          </div>
        </button>
      );
    }

    function ModalWrapper({ open, title, children, footer, onClose }){
      if(!open) return null;
      return (
        <div className="absolute inset-0 z-50 flex items-center justify-center p-4">
          <div className="absolute inset-0 bg-black/40" onClick={onClose}></div>
          <div className="relative w-full max-w-[420px] neo-card pop-in">
            <div className="p-3 border-b-2 border-black bg-white">
              <div className="flex items-center justify-between gap-2">
                <div className="font-pixel text-4xl leading-none">{title}</div>
                <button className="neo-btn px-3 py-1 rounded-xl bg-white font-pixel text-3xl" onClick={onClose}>X</button>
              </div>
            </div>
            <div className="p-3 bg-white">
              {children}
            </div>
            {footer ? <div className="p-3 border-t-2 border-black bg-white">{footer}</div> : null}
          </div>
        </div>
      );
    }

    function InfoModal({ title, body, onClose }){
      return (
        <ModalWrapper
          open={true}
          title={title || "æç¤º"}
          onClose={onClose}
          footer={
            <button className="neo-btn w-full rounded-2xl py-3 bg-emerald-200 font-pixel text-3xl" onClick={onClose}>
              ç¢ºèª
            </button>
          }
        >
          <div className="flex items-start gap-2">
            <div className="text-black mt-1"><IconInfo /></div>
            <div className="text-sm font-semibold text-gray-900 whitespace-pre-wrap">{body}</div>
          </div>
        </ModalWrapper>
      );
    }

    function QuizModal({ title, questions, onCancel, onSubmit }){
      const [answers, setAnswers] = useState(()=> (questions||[]).map(()=> null));
      const [submitted, setSubmitted] = useState(false);
      const [errorMsg, setErrorMsg] = useState("");

      const answeredCount = answers.filter(a => a !== null).length;
      const totalCount = (questions||[]).length;

      function pick(i, optionIndex){
        if(submitted) return;
        setErrorMsg("");
        setAnswers(prev=>{
          const next = prev.slice();
          next[i] = optionIndex;
          return next;
        });
      }

      function grade(){
        if(submitted) return;

        const firstUnanswered = answers.findIndex(a => a === null);
        if(firstUnanswered !== -1){
          setErrorMsg(`ä½ é‚„æœ‰ ${totalCount - answeredCount} é¡Œæœªä½œç­”ï¼Œè«‹å¾€ä¸‹æ»‘å®Œæˆå¾Œå†é€å‡ºã€‚`);
          const el = document.getElementById(`q-${firstUnanswered}`);
          if(el) el.scrollIntoView({ behavior:"smooth", block:"start" });
          return;
        }

        let correct = 0;
        for(let i=0; i<totalCount; i++){
          const q = questions[i];
          if(answers[i] === q.answerIndex) correct++;
        }
        const passed = (correct === totalCount && totalCount > 0);
        setSubmitted(true);
        onSubmit(passed);
      }

      return (
        <ModalWrapper
          open={true}
          title={title || "æ¸¬é©—"}
          onClose={onCancel}
          footer={
            <div className="grid grid-cols-2 gap-2">
              <button className="neo-btn w-full rounded-2xl py-3 bg-white font-pixel text-3xl" onClick={onCancel}>
                å–æ¶ˆ
              </button>
              <button className="neo-btn w-full rounded-2xl py-3 bg-emerald-200 font-pixel text-3xl" onClick={grade}>
                é€å‡º
              </button>
            </div>
          }
        >
          <div className="text-xs font-semibold text-gray-700">
            è¦å‰‡ï¼šæŠ½ 3 é¡Œï¼Œå…¨å°æ‰ç®—é€šéã€‚ï½œå·²ä½œç­” {answeredCount}/{totalCount}ï¼ˆå¯å¾€ä¸‹æ»‘ï¼‰
          </div>

          {errorMsg ? (
            <div className="mt-2 text-xs font-semibold text-rose-700 border-2 border-rose-700 rounded-xl p-2 bg-rose-50">
              {errorMsg}
            </div>
          ) : null}

          <div className="mt-3 space-y-3 max-h-[60vh] overflow-auto pr-1">
            {(questions||[]).map((q, idx)=>(
              <div key={idx} id={`q-${idx}`} className="border-2 border-black rounded-2xl p-3 bg-white">
                <div className="flex items-center justify-between gap-2">
                  <div className="font-pixel text-3xl leading-none">Q{idx+1}</div>
                  <SmallBadge text="å¿…ç­”" tone="bg-black text-white" />
                </div>
                <div className="mt-1 text-sm font-semibold text-gray-900">{q.q}</div>
                <div className="mt-2 grid grid-cols-1 gap-2">
                  {(q.options||[]).map((opt, oi)=>(
                    <button
                      key={oi}
                      className={"neo-btn rounded-2xl p-2 text-left " + (answers[idx]===oi ? "bg-black text-white" : "bg-white")}
                      onClick={()=>pick(idx, oi)}
                    >
                      <div className={"text-sm font-semibold " + (answers[idx]===oi ? "text-white" : "text-gray-900")}>
                        {opt}
                      </div>
                    </button>
                  ))}
                </div>
              </div>
            ))}
          </div>
        </ModalWrapper>
      );
    }

    function FloatingTextOverlay({ floats }){
      return (
        <div className="absolute inset-0 pointer-events-none z-40">
          {floats.map(f=>(
            <div
              key={f.id}
              className={"absolute left-1/2 top-[160px] -translate-x-1/2 float-up font-pixel text-5xl " + (f.colorClass || "text-emerald-700")}
              style={{ marginLeft: (f.offsetX || 0) + "px" }}
            >
              {f.text}
            </div>
          ))}
        </div>
      );
    }

    /********************
     * App
     ********************/
    function App(){
      const [screen, setScreen] = useState("onboarding"); // onboarding | home | app_house | app_job | app_resource | app_finance
      const [phase, setPhase] = useState("wheel"); // wheel | identity | password
      const [spinning, setSpinning] = useState(false);
      const [origin, setOrigin] = useState(null);

      const [money, setMoney] = useState(INITIAL_STATS.money);
      const [health, setHealth] = useState(INITIAL_STATS.health);
      const [mood, setMood] = useState(INITIAL_STATS.mood);
      const [security, setSecurity] = useState(INITIAL_STATS.security);
      const [week, setWeek] = useState(INITIAL_STATS.week);
      const [maxWeeks, setMaxWeeks] = useState(INITIAL_STATS.maxWeeks);
      const [age, setAge] = useState(INITIAL_STATS.age);
      const [ap, setAp] = useState(INITIAL_STATS.ap);
      const [maxAp, setMaxAp] = useState(INITIAL_STATS.maxAp);

      const [hasHouse, setHasHouse] = useState(false);
      const [houseName, setHouseName] = useState("");
      const [houseTag, setHouseTag] = useState(""); // ccsa / others

      const [items, setItems] = useState([]); // strings
      const [bills, setBills] = useState([]); // {id, name, amountPerWeek, remainingWeeks}
      const [logs, setLogs] = useState([]);
      const [ledger, setLedger] = useState([]); // {id, name, amount, ts}

      const [modal, setModal] = useState(null); // {kind, ...}
      const [floats, setFloats] = useState([]);
      const [glitch, setGlitch] = useState(false);

      const floatIdRef = useRef(1);
      const logIdRef = useRef(1);

      function pushLog(text){
        setLogs(prev=>{
          const next = prev.concat([{ id: logIdRef.current++, text, ts: Date.now() }]);
          return next.slice(-60);
        });
      }

      function hasItem(key){
        return items.includes(key);
      }

      function addItem(key){
        setItems(prev => prev.includes(key) ? prev : prev.concat([key]));
      }

      function addFloating({ type, delta, text }){
        const id = floatIdRef.current++;
        let colorClass = "text-emerald-700";
        if(type === "bad") colorClass = "text-rose-700";
        if(type === "warn") colorClass = "text-yellow-700";
        if(delta < 0) colorClass = "text-rose-700";
        if(delta > 0) colorClass = "text-emerald-700";
        const sign = (delta > 0 ? "+" : "");
        const t = text != null ? text : (sign + delta);
        const offsetX = (Math.random() * 50 - 25);
        setFloats(prev => prev.concat([{ id, text: t, colorClass, offsetX }]));
        window.setTimeout(()=> {
          setFloats(prev => prev.filter(x => x.id !== id));
        }, 950);
      }

      function triggerGlitch(){
        setGlitch(true);
        window.setTimeout(()=> setGlitch(false), 520);
      }

      function applyDeltas(deltas, reason){
        if(!deltas) return;
        const dm = deltas.money || 0;
        const dh = deltas.health || 0;
        const dmo = deltas.mood || 0;
        const ds = deltas.security || 0;
        const dap = deltas.ap || 0;

        if(dm !== 0){ setMoney(v => v + dm); addFloating({ type: "money", delta: dm, text: (dm>0?`+$${dm}`:`-$${Math.abs(dm)}`) }); }
        if(dh !== 0){ setHealth(v => clamp(v + dh, 0, 100)); addFloating({ type: "health", delta: dh, text: (dh>0?`é«”åŠ›+${dh}`:`é«”åŠ›${dh}`) }); }
        if(dmo !== 0){ setMood(v => clamp(v + dmo, 0, 100)); addFloating({ type: "mood", delta: dmo, text: (dmo>0?`å¿ƒæƒ…+${dmo}`:`å¿ƒæƒ…${dmo}`) }); }
        if(ds !== 0){ setSecurity(v => clamp(v + ds, 0, 100)); addFloating({ type: "security", delta: ds, text: (ds>0?`è³‡å®‰+${ds}`:`è³‡å®‰${ds}`) }); }
        if(dap !== 0){ setAp(v => clamp(v + dap, 0, maxAp)); addFloating({ type: "ap", delta: dap, text: (dap>0?`AP+${dap}`:`AP${dap}`) }); }

        const lowMood = (mood + dmo) < 30;
        const lowSec = (security + ds) < 30;
        if(lowMood || lowSec) triggerGlitch();

        if(reason) pushLog(reason);
      }

      function computeLivingCost(){
        let livingCost = 1500;
        if(hasHouse && houseTag !== "ccsa") livingCost += 500;
        return livingCost;
      }

      /********************
       * Onboarding
       ********************/
      function spinDestiny(){
        if(spinning) return;
        setSpinning(true);
        pushLog("ğŸ¡ å‘½é‹è½‰ç›¤ï¼šé–‹å§‹è½‰å‹•â€¦");
        window.setTimeout(()=>{
          const o = pickOrigin();
          const a = 15 + Math.floor(Math.random() * 5); // 15~19
          setOrigin(o);
          setAge(a);
          setMoney(o.money);
          pushLog(`ğŸ¯ æŠ½åˆ°ç­‰ç´š ${o.grade}ï¼ˆ${o.label}ï¼‰ï¼Œèµ·å§‹é‡‘é¡ $${o.money}ï¼Œå¹´é½¡ ${a} æ­²ã€‚`);
          setPhase("identity");
          setSpinning(false);
        }, 2000);
      }

      function choosePassword(kind){
        if(kind === "weak"){
          applyDeltas({ security: -20 }, "ğŸ”“ ä½ é¸äº† 123456ï¼Œè³‡å®‰ä¸‹é™ã€‚");
          setScreen("home");
        } else {
          applyDeltas({ security: +10 }, "ğŸ” ä½ é–‹å•Ÿ 2FAï¼Œè³‡å®‰æå‡ã€‚");
          setScreen("home");
        }
      }

      /********************
       * Week advance
       ********************/
      function advanceWeek(){
        if(modal) return;
        if(week >= maxWeeks){
          setModal({
            kind: "info",
            title: "å·²åˆ°æœ€å¾Œä¸€é€±",
            body: "ä½ å·²å®Œæˆ 8 é€±æŒ‘æˆ°ï¼å¯å›é¡§ä½ çš„é¸æ“‡èˆ‡è³‡æºä½¿ç”¨ã€‚",
            onClose: ()=> setModal(null)
          });
          return;
        }

        const livingCost = computeLivingCost();
        pushLog(`ğŸ“… çµæŸæœ¬é€±ï¼šæ‰£é™¤åŸºæœ¬æ”¯å‡º $${livingCost}ã€‚`);
        setMoney(v => v - livingCost);
        addFloating({ type: "money", delta: -livingCost, text: `-$${livingCost}` });

        // bills weekly deduction
        setBills(prev=>{
          let next = prev.slice();
          for(const b of next){
            // deduct
            setMoney(v => v - b.amountPerWeek);
            addFloating({ type: "money", delta: -b.amountPerWeek, text: `å¸³å–® -$${b.amountPerWeek}` });
            pushLog(`ğŸ§¾ æ‰£æ¬¾ï¼š${b.name} -$${b.amountPerWeek}ï¼ˆå‰© ${b.remainingWeeks-1} é€±ï¼‰`);
            b.remainingWeeks -= 1;
          }
          next = next.filter(b => b.remainingWeeks > 0);
          return next;
        });

        setWeek(w => w + 1);
        setAp(maxAp);
        setMood(v => clamp(v - 5, 0, 100));
        setSecurity(v => clamp(v - 2, 0, 100));
        addFloating({ type: "mood", delta: -5, text: "å¿ƒæƒ…-5" });
        addFloating({ type: "security", delta: -2, text: "è³‡å®‰-2" });
        pushLog("ğŸ§  å£“åŠ›ç´¯ç©ï¼šå¿ƒæƒ…-5ã€è³‡å®‰-2ï¼ŒAP å›æ»¿ã€‚");

        // eviction check after a short tick so money updates settle
        window.setTimeout(()=>{
          setMoney(current=>{
            if(current < 0 && hasHouse && houseTag !== "ccsa"){
              setHasHouse(false);
              setHouseName("");
              setHouseTag("");
              setMood(v => clamp(v - 30, 0, 100));
              setSecurity(v => clamp(v - 10, 0, 100));
              addFloating({ type: "bad", delta: -30, text: "è¢«é©…é€ï¼å¿ƒæƒ…-30" });
              addFloating({ type: "bad", delta: -10, text: "è³‡å®‰-10" });
              pushLog("ğŸšï¸ è¢«é©…é€ï¼šè³‡é‡‘ç‚ºè² ä¸”é CCSA ä½å®¿ï¼Œå¤±å»å±…æ‰€ã€‚");
              triggerGlitch();
            }
            return current;
          });

          // trigger random event after 1s
          window.setTimeout(()=> triggerRandomEvent(), 1000);
        }, 80);
      }

      /********************
       * Random Event
       ********************/
      function triggerRandomEvent(){
        if(modal) return;

        const roll = Math.random();
        if(roll > 0.6){
          pushLog("ğŸ“­ æœ¬é€±æ²’æœ‰é¡å¤–äº‹ä»¶ã€‚");
          setScreen("home");
          return;
        }

        const weights = [
          { id: "friend_loan", w: 3 },
          { id: "scam_romance", w: 3 },
          { id: "scam_job", w: 3 },
          { id: "accident", w: 2 },
          { id: "sickness", w: (health < 50 ? 4 : 2) },
        ];

        if(!hasHouse) weights.push({ id: "police", w: 4 });
        else weights.push({ id: "police", w: 2 });

        const picked = weightedPick(weights);
        const scenario = SCENARIOS[picked];
        if(!scenario){
          pushLog("âš ï¸ äº‹ä»¶è³‡æ–™ç¼ºæ¼ï¼Œå›åˆ° Homeã€‚");
          setScreen("home");
          return;
        }

        setModal({
          kind: "event",
          title: scenario.title,
          body: scenario.body,
          choices: scenario.choices,
          onClose: ()=> setModal(null),
        });
      }

      function applyScenarioChoice(choice){
        if(!choice || !choice.effect) return;
        const ctx = { money, health, mood, security, age, items: items.slice(), hasHouse, houseTag };
        const res = choice.effect(ctx) || {};
        const deltas = res.deltas || {};
        const log = res.log || "ï¼ˆäº‹ä»¶å·²è™•ç†ï¼‰";
        applyDeltas(deltas, log);
        setModal(null);
        setScreen("home");
      }

      /********************
       * Quiz helpers
       ********************/
      function getQuizQuestions(quizKey, count=3){
        const pool = (QUIZ_DB && QUIZ_DB[quizKey]) ? QUIZ_DB[quizKey] : null;
        const fallback = (QUIZ_DB && QUIZ_DB["house_check"]) ? QUIZ_DB["house_check"] : [];

        if(!pool){
          pushLog(`âš ï¸ é¡Œåº«ç¼ºæ¼ï¼š${quizKey}ï¼Œæ”¹ç”¨ house_check`);
          try { window.__showErrorBox && window.__showErrorBox(`é¡Œåº«ç¼ºæ¼ï¼š${quizKey}ï¼ˆå·²æ”¹ç”¨ house_checkï¼‰`); } catch(e){}
        }

        const source = (pool && pool.length) ? pool : fallback;
        const picked = shuffleArray(source).slice(0, Math.min(count, source.length));

        if(!picked.length){
          return [{
            q: "ç³»çµ±é¡Œåº«å°šæœªè¼‰å…¥ï¼Œè«‹é‡æ–°æ•´ç†å¾Œå†è©¦ä¸€æ¬¡ã€‚",
            options: ["äº†è§£"],
            answerIndex: 0
          }];
        }
        return picked;
      }

      /********************
       * Job App
       ********************/
      function startJobApply(job){
        if(modal) return;
        if(ap <= 0){
          pushLog("âŒ AP ä¸è¶³ï¼Œç„¡æ³•æ‡‰å¾µã€‚");
          addFloating({ type: "warn", delta: 0, text: "APä¸è¶³" });
          return;
        }

        if(age < job.minAge){
          const canByAccompany = hasItem("accompaniment_card") && !job.strictAge;
          if(!canByAccompany){
            setModal({
              kind: "info",
              title: "å¹´é½¡é™åˆ¶",
              body: `æ­¤è·ç¼ºæœ€ä½å¹´é½¡ ${job.minAge} æ­²ã€‚\nè‹¥æœªæ»¿ä¸”è·ç¼ºä¸å±¬åš´æ ¼é™åˆ¶ï¼Œå¯å…ˆç”³è«‹ã€Œç¤¾å·¥é™ªåŒå¡ã€å†å˜—è©¦ã€‚`,
              onClose: ()=> setModal(null)
            });
            return;
          }
          pushLog("ğŸ§‘â€ğŸ¤â€ğŸ§‘ ä½ æœ‰ç¤¾å·¥é™ªåŒå¡ï¼Œå¹´é½¡ä¸è¶³ä»å¯å˜—è©¦ï¼ˆéåš´æ ¼è·ç¼ºï¼‰ã€‚");
        }

        // consume AP
        setAp(v => clamp(v - job.apCost, 0, maxAp));
        addFloating({ type: "ap", delta: -job.apCost, text: `AP-${job.apCost}` });

        const pool = []
          .concat(job.interviews || [])
          .concat(GENERIC_JOB_QUESTIONS || []);
        const picked = shuffleArray(pool).slice(0, 3);

        setModal({
          kind: "quiz",
          title: `é¢è©¦æ¸¬é©—ï½œ${job.title}`,
          questions: picked,
          onCancel: ()=>{
            pushLog("â¹ï¸ å·²å–æ¶ˆé¢è©¦æ¸¬é©—ã€‚");
            setModal(null);
          },
          onSubmit: (passed)=>{
            setModal(null);
            if(!passed){
              applyDeltas({ mood: -10 }, `âŒ é¢è©¦æœªé€šéï¼š${job.title}ï¼ˆå¿ƒæƒ…-10ï¼‰`);
              setScreen("app_job");
              return;
            }
            const earn = job.wage * 8;
            applyDeltas(
              { money: +earn, health: -job.energy, mood: +job.mood },
              `âœ… é¢è©¦é€šéï¼š${job.title}ï¼Œç²å¾— $${earn}ï¼ˆ8å°æ™‚ï¼‰ï¼Œé«”åŠ›-${job.energy}ã€‚`
            );
            setScreen("app_job");
          }
        });
      }

      /********************
       * Housing App
       ********************/
      function signHouse(house){
        const rent = house.rent || 0;
        const deposit = house.deposit || 0;
        const isCCSA = (house.tag === "ccsa");
        // under 18 rule
        if(age < 18 && !isCCSA && !hasItem("accompaniment_card")){
          setModal({
            kind: "info",
            title: "éœ€è¦é™ªåŒ",
            body: "æœªæ»¿ 18 æ­²è€…ï¼Œé™¤ CCSA å¤–éœ€æœ‰ã€Œç¤¾å·¥é™ªåŒå¡ã€æ‰èƒ½é€²è¡Œç§Ÿå±‹ç°½ç´„ã€‚\nè«‹å…ˆåˆ°ã€è³‡æºåœ°åœ– â†’ CCSA è‡ªç«‹æœå‹™ã€‘ç”³è«‹ç¤¾å·¥é™ªåŒã€‚",
            onClose: ()=> setModal(null),
          });
          return;
        }

        if(deposit > 0 && money < deposit){
          setModal({
            kind: "info",
            title: "æŠ¼é‡‘ä¸è¶³",
            body: `ç°½ç´„éœ€è¦æŠ¼é‡‘ $${deposit}ï¼Œç›®å‰ç¾é‡‘ä¸è¶³ã€‚\nå¯å…ˆæ‰¾å·¥ä½œæˆ–åˆ°è³‡æºåœ°åœ–å°‹æ±‚å”åŠ©ã€‚`,
            onClose: ()=> setModal(null),
          });
          return;
        }

        // success
        setHasHouse(true);
        setHouseName(house.title);
        setHouseTag(house.tag || "");
        if(deposit > 0){
          setMoney(v => v - deposit);
          addFloating({ type: "money", delta: -deposit, text: `æŠ¼é‡‘-$${deposit}` });
        }
        if(house.securityDelta){
          setSecurity(v => clamp(v + house.securityDelta, 0, 100));
          addFloating({ type: "security", delta: house.securityDelta, text: (house.securityDelta>0?`è³‡å®‰+${house.securityDelta}`:`è³‡å®‰${house.securityDelta}`) });
        }
        pushLog(`ğŸ  ç°½ç´„æˆåŠŸï¼š${house.title}${deposit>0?`ï¼ˆæŠ¼é‡‘-$${deposit}ï¼‰`:""}ã€‚`);
      }

      function openHouseQuiz(house){
        if(modal) return;
        if(!house) return;

        if(ap <= 0){
          pushLog("âŒ AP ä¸è¶³ï¼Œç„¡æ³•é ç´„çœ‹æˆ¿ã€‚");
          addFloating({ type: "warn", delta: 0, text: "APä¸è¶³" });
          return;
        }

        const isCCSA = (house.tag === "ccsa");
        if(age < 18 && !isCCSA && !hasItem("accompaniment_card")){
          setModal({
            kind: "info",
            title: "éœ€è¦é™ªåŒ",
            body: "æœªæ»¿ 18 æ­²è€…ï¼Œé™¤ CCSA å¤–éœ€æœ‰ã€Œç¤¾å·¥é™ªåŒå¡ã€æ‰èƒ½é€²è¡Œç§Ÿå±‹ç°½ç´„ã€‚\nè«‹å…ˆåˆ°ã€è³‡æºåœ°åœ– â†’ CCSA è‡ªç«‹æœå‹™ã€‘ç”³è«‹ç¤¾å·¥é™ªåŒã€‚",
            onClose: ()=> setModal(null),
          });
          return;
        }

        setAp(v => clamp(v - 1, 0, maxAp));
        addFloating({ type: "ap", delta: -1, text: "AP-1" });
        pushLog(`ğŸ“Œ é ç´„çœ‹æˆ¿ï¼š${house.title}`);

        const quizKey = house.quizKey || "house_check";
        const questions = getQuizQuestions(quizKey, 3);

        setModal({
          kind: "quiz",
          title: `çœ‹æˆ¿æ¸¬é©—ï½œ${house.title}`,
          questions,
          onCancel: ()=>{
            pushLog("â¹ï¸ å·²å–æ¶ˆçœ‹æˆ¿æ¸¬é©—ã€‚");
            setModal(null);
          },
          onSubmit: (passed)=>{
            setModal(null);
            if(!passed){
              applyDeltas({ mood: -10 }, `âŒ çœ‹æˆ¿æ¸¬é©—æœªé€šéï¼š${house.title}ï¼ˆå¿ƒæƒ…-10ï¼‰`);
              setScreen("app_house");
              return;
            }
            signHouse(house);
            setScreen("app_house");
          }
        });
      }

      /********************
       * Resource Map
       ********************/
      function doResourceAction(actionId){
        if(modal) return;

        if(actionId === "apply_accompaniment"){
          if(ap <= 0){
            pushLog("âŒ AP ä¸è¶³ï¼Œç„¡æ³•ç”³è«‹é™ªåŒã€‚");
            addFloating({ type: "warn", delta: 0, text: "APä¸è¶³" });
            return;
          }
          if(hasItem("accompaniment_card")){
            setModal({
              kind: "info",
              title: "å·²æŒæœ‰é™ªåŒå¡",
              body: "ä½ å·²ç¶“æœ‰ã€Œç¤¾å·¥é™ªåŒå¡ã€ï¼Œä¸éœ€è¦é‡è¤‡ç”³è«‹ã€‚",
              onClose: ()=> setModal(null)
            });
            return;
          }
          setAp(v => clamp(v - 1, 0, maxAp));
          addFloating({ type: "ap", delta: -1, text: "AP-1" });
          addItem("accompaniment_card");
          pushLog("ğŸ§‘â€ğŸ¤â€ğŸ§‘ å–å¾—ï¼šç¤¾å·¥é™ªåŒå¡ï¼ˆå¯å”åŠ©éƒ¨åˆ†å¹´é½¡é™åˆ¶èˆ‡ç°½ç´„æµç¨‹ï¼‰ã€‚");
          return;
        }

        if(actionId === "police_good_card"){
          if(age < 18){
            setModal({
              kind: "info",
              title: "å¹´é½¡é™åˆ¶",
              body: "æœªæ»¿ 18 æ­²éœ€æ³•ä»£/ç›£è­·äººå”åŠ©è¾¦ç†ã€‚\nå¯å…ˆå°ˆæ³¨åœ¨å®‰å…¨è¦åŠƒèˆ‡è³‡æºé€£çµã€‚",
              onClose: ()=> setModal(null)
            });
            return;
          }
          if(hasItem("good_citizen_card")){
            setModal({
              kind: "info",
              title: "å·²æŒæœ‰è‰¯æ°‘å¡",
              body: "ä½ å·²ç¶“é ˜å–éè‰¯æ°‘å¡ã€‚",
              onClose: ()=> setModal(null)
            });
            return;
          }
          addItem("good_citizen_card");
          pushLog("ğŸªª å–å¾—ï¼šè‰¯æ°‘å¡ï¼ˆåœ¨è­¦æ–¹äº’å‹•æ™‚å¯èƒ½æ›´é †åˆ©ï¼‰ã€‚");
          addFloating({ type: "security", delta: +2, text: "è³‡å®‰+2" });
          setSecurity(v => clamp(v + 2, 0, 100));
          return;
        }

        // Quiz-based actions
        let quizKey = null;
        let onPass = null;
        let title = "";
        if(actionId === "job_test"){
          quizKey = "job_test";
          title = "å°±æ¥­æœå‹™ç«™æ¸¬é©—";
          onPass = ()=>{
            applyDeltas({ money: +1000, security: +2 }, "ğŸ¢ å°±æœç«™ï¼šæ¸¬é©—å…¨å°ï¼Œçå‹µ $1000ï¼ˆè³‡å®‰+2ï¼‰ã€‚");
          };
        } else if(actionId === "welfare_help"){
          quizKey = "welfare_help";
          title = "ç¤¾æœƒç¦åˆ©ä¸­å¿ƒè«®è©¢";
          onPass = ()=>{
            applyDeltas({ health: +20, mood: +5 }, "ğŸ¤² ç¦åˆ©ä¸­å¿ƒï¼šå®Œæˆè©•ä¼°èˆ‡é€£çµï¼ˆé«”åŠ›+20ã€å¿ƒæƒ…+5ï¼‰ã€‚");
          };
        } else if(actionId === "finance_help"){
          if(money >= 2000){
            setModal({
              kind: "info",
              title: "ä¸ç¬¦åˆæ¢ä»¶",
              body: "è²¡å‹™æ€¥é›£è£œåŠ©éœ€åœ¨è³‡é‡‘æ›´åƒç·Šæ™‚æ‰å¯ç”³è«‹ï¼ˆmoney < 2000ï¼‰ã€‚",
              onClose: ()=> setModal(null)
            });
            return;
          }
          quizKey = "finance_help";
          title = "æ€¥é›£è£œåŠ©ç”³è«‹";
          onPass = ()=>{
            applyDeltas({ money: +5000, mood: +6 }, "ğŸ§¾ æ€¥é›£è£œåŠ©ï¼šç”³è«‹é€šéï¼Œç²å¾— $5000ï¼ˆå¿ƒæƒ…+6ï¼‰ã€‚");
          };
        } else if(actionId === "ccsa_aid"){
          quizKey = "welfare_help";
          title = "CCSA è‡ªç«‹æœå‹™å”åŠ©";
          onPass = ()=>{
            applyDeltas({ money: +3000, mood: +6, security: +2 }, "ğŸ  CCSAï¼šè‡ªç«‹å”åŠ©é€šéï¼Œç²å¾— $3000ï¼ˆå¿ƒæƒ…+6ã€è³‡å®‰+2ï¼‰ã€‚");
          };
        } else if(actionId === "ccsa_counseling"){
          quizKey = "welfare_help";
          title = "å¿ƒç†è«®å•†";
          onPass = ()=>{
            applyDeltas({ mood: +30, health: +10 }, "ğŸ§  è«®å•†æ”¯æŒï¼šè¦ºå¯Ÿæå‡ï¼ˆå¿ƒæƒ…+30ã€é«”åŠ›+10ï¼‰ã€‚");
          };
        } else if(actionId === "ccsa_training"){
          quizKey = "job_test";
          title = "è‡ªç«‹åŸ¹è¨“";
          onPass = ()=>{
            setMaxAp(v => v + 1);
            setAp(v => v + 1);
            applyDeltas({ mood: +10 }, "ğŸ“š è‡ªç«‹åŸ¹è¨“ï¼šä½ è®Šå¾—æ›´æœ‰èƒ½é‡ï¼ˆmaxAP+1ã€å¿ƒæƒ…+10ï¼‰ã€‚");
          };
        } else {
          pushLog("âš ï¸ æœªçŸ¥è³‡æºè¡Œå‹•ã€‚");
          return;
        }

        if(ap <= 0){
          pushLog("âŒ AP ä¸è¶³ï¼Œç„¡æ³•é€²è¡Œæ­¤è³‡æºè¡Œå‹•ã€‚");
          addFloating({ type: "warn", delta: 0, text: "APä¸è¶³" });
          return;
        }

        setAp(v => clamp(v - 1, 0, maxAp));
        addFloating({ type: "ap", delta: -1, text: "AP-1" });

        const questions = getQuizQuestions(quizKey, 3);
        setModal({
          kind: "quiz",
          title,
          questions,
          onCancel: ()=>{
            pushLog("â¹ï¸ å·²å–æ¶ˆè³‡æºæµç¨‹ã€‚");
            setModal(null);
          },
          onSubmit: (passed)=>{
            setModal(null);
            if(!passed){
              applyDeltas({ mood: -8 }, "âŒ æœªé€šéæµç¨‹ï¼ˆå¿ƒæƒ…-8ï¼‰ã€‚");
              setScreen("app_resource");
              return;
            }
            onPass && onPass();
            setScreen("app_resource");
          }
        });
      }

      /********************
       * Shop (payment methods)
       ********************/
      function openShop(){
        setModal({
          kind: "shop",
          title: "å•†åº—",
          onClose: ()=> setModal(null)
        });
      }

      function buyItem(item, payMethod){
        if(!item) return;

        if(item.ageMin && age < item.ageMin){
          setModal({
            kind: "info",
            title: "å¹´é½¡é™åˆ¶",
            body: `æ­¤å“é …éœ€å¹´é½¡ ${item.ageMin} æ­²ä»¥ä¸Šã€‚`,
            onClose: ()=> setModal(null)
          });
          return;
        }

        if(payMethod === "credit" && age < 18){
          setModal({
            kind: "info",
            title: "ä¿¡ç”¨å¡é™åˆ¶",
            body: "ä¿¡ç”¨å¡ä»˜æ¬¾éœ€å¹´æ»¿ 18 æ­²ã€‚",
            onClose: ()=> setModal(null)
          });
          return;
        }

        const price = item.price || 0;

        if(payMethod === "cash"){
          if(money < price){
            setModal({
              kind: "info",
              title: "ç¾é‡‘ä¸è¶³",
              body: `æ­¤å“é …éœ€è¦ $${price}ï¼Œç›®å‰ç¾é‡‘ä¸è¶³ã€‚`,
              onClose: ()=> setModal(null)
            });
            return;
          }
          setMoney(v => v - price);
          addFloating({ type: "money", delta: -price, text: `-$${price}` });
          pushLog(`ğŸ›’ è³¼è²·ï¼š${item.title}ï¼ˆç¾é‡‘ -$${price}ï¼‰`);
        }

        if(payMethod === "credit"){
          // next week deduction
          const bill = {
            id: "bill_" + Date.now() + "_" + Math.floor(Math.random()*9999),
            name: `ä¿¡ç”¨å¡ï¼š${item.title}`,
            amountPerWeek: price,
            remainingWeeks: 1
          };
          setBills(prev => prev.concat([bill]));
          pushLog(`ğŸ’³ è³¼è²·ï¼š${item.title}ï¼ˆä¿¡ç”¨å¡ï¼Œä¸‹é€±æ‰£ $${price}ï¼‰`);
        }

        if(payMethod === "bnpl"){
          // total +20% split 4 weeks
          const total = Math.ceil(price * 1.2);
          const per = Math.ceil(total / 4);
          const bill = {
            id: "bill_" + Date.now() + "_" + Math.floor(Math.random()*9999),
            name: `BNPL åˆ†4æœŸï¼š${item.title}`,
            amountPerWeek: per,
            remainingWeeks: 4
          };
          setBills(prev => prev.concat([bill]));
          pushLog(`ğŸ§¾ è³¼è²·ï¼š${item.title}ï¼ˆBNPL åˆ†4æœŸï¼Œç¸½ $${total}ï¼Œæ¯é€±ç´„ $${per}ï¼‰`);
        }

        // apply effects / scam
        if(item.scam){
          applyDeltas({ mood: -30, security: -5 }, "ğŸš« é€™æ˜¯æŠ•è³‡è©é¨™ï¼ä½ æå¤±é‡‘éŒ¢ä¸”å¿ƒæƒ…å¤§æ¸›ã€‚");
          // no item granted
          setModal(null);
          return;
        }

        const eff = item.effects || {};
        const d = {};
        if(eff.health) d.health = (d.health||0) + eff.health;
        if(eff.mood) d.mood = (d.mood||0) + eff.mood;
        if(eff.security) d.security = (d.security||0) + eff.security;

        if(eff.item){
          addItem(eff.item);
          pushLog(`ğŸ’ å–å¾—é“å…·ï¼š${eff.item}`);
        }
        if(Object.keys(d).length){
          applyDeltas(d, `âœ¨ æ•ˆæœå¥—ç”¨ï¼š${item.title}`);
        }

        setModal(null);
      }

      /********************
       * Finance (renderFinanceApp å¿…é ˆå­˜åœ¨)
       ********************/
      function addLedgerEntry(name, amount){
        const a = Number(amount);
        if(!name || !Number.isFinite(a) || a === 0){
          setModal({
            kind: "info",
            title: "è¼¸å…¥ä¸å®Œæ•´",
            body: "è«‹è¼¸å…¥åç¨±èˆ‡é‡‘é¡ï¼ˆæ”¶å…¥ç‚ºæ­£æ•¸ã€æ”¯å‡ºç‚ºè² æ•¸ï¼‰ã€‚",
            onClose: ()=> setModal(null)
          });
          return;
        }
        const entry = { id: "ld_" + Date.now() + "_" + Math.floor(Math.random()*9999), name, amount: a, ts: Date.now() };
        setLedger(prev => [entry, ...prev].slice(0, 30));
        setMoney(v => v + a);
        addFloating({ type: "money", delta: a, text: (a>0?`æ”¶å…¥+$${a}`:`æ”¯å‡º-$${Math.abs(a)}`) });
        pushLog(`ğŸ§¾ è¨˜å¸³ï¼š${name}ï¼ˆ${a>0?`+${a}`:`${a}`}ï¼‰`);
      }

      function renderFinanceApp(){
        const livingCost = computeLivingCost();
        return (
          <div className="h-full flex flex-col">
            <TopNav title="è²¡å‹™ç®¡å®¶" onHome={()=>setScreen("home")} />
            <div className="p-3 space-y-3 overflow-auto">
              <div className="neo-card p-3">
                <div className="font-pixel text-5xl leading-none">ç¾é‡‘é¤˜é¡</div>
                <div className="mt-1 font-pixel text-6xl leading-none">${money}</div>
                <div className="mt-2 text-xs font-semibold text-gray-700">æœ¬é€±å›ºå®šæ”¯å‡ºï¼ˆè¨ˆç®—ç”¨ï¼‰ï¼š{livingCost}</div>
              </div>

              <div className="neo-card p-3">
                <div className="flex items-center justify-between gap-2">
                  <div className="font-pixel text-5xl leading-none">æœªç¹³å¸³å–®</div>
                  <SmallBadge text={bills.length ? `${bills.length} ç­†` : "ç„¡"} tone={bills.length ? "bg-rose-100 text-rose-700" : "bg-emerald-100 text-emerald-700"} />
                </div>
                <div className="mt-2 space-y-2">
                  {bills.length ? bills.map(b=>(
                    <div key={b.id} className="border-2 border-black rounded-2xl p-2 bg-white">
                      <div className="flex items-center justify-between gap-2">
                        <div className="text-sm font-semibold text-gray-900">{b.name}</div>
                        <div className="font-pixel text-4xl leading-none">-${b.amountPerWeek}</div>
                      </div>
                      <div className="text-xs font-semibold text-gray-700">å‰©é¤˜é€±æ•¸ï¼š{b.remainingWeeks}</div>
                    </div>
                  )) : (
                    <div className="text-sm font-semibold text-gray-700">ç›®å‰æ²’æœ‰åˆ†æœŸ/ä¿¡ç”¨å¸³å–®ã€‚</div>
                  )}
                </div>
              </div>

              <button className="neo-btn w-full rounded-2xl py-3 bg-emerald-200 font-pixel text-4xl" onClick={openShop}>
                <span className="inline-flex items-center gap-2 justify-center"><IconShop /> æ‰“é–‹å•†åº—</span>
              </button>

              <div className="neo-card p-3">
                <div className="font-pixel text-5xl leading-none">è¨˜å¸³å°å·¥å…·</div>
                <div className="mt-2 text-xs font-semibold text-gray-700">è¼¸å…¥é‡‘é¡ï¼šæ”¶å…¥å¡«æ­£æ•¸ï¼Œæ”¯å‡ºå¡«è² æ•¸ã€‚</div>
                <FinanceLedgerForm onAdd={addLedgerEntry} />
                <div className="mt-3 space-y-2">
                  {ledger.length ? ledger.map(l=>(
                    <div key={l.id} className="border-2 border-black rounded-2xl p-2 bg-white">
                      <div className="flex items-center justify-between gap-2">
                        <div className="text-sm font-semibold text-gray-900">{l.name}</div>
                        <div className={"font-pixel text-4xl leading-none " + (l.amount>=0 ? "text-emerald-700" : "text-rose-700")}>
                          {l.amount>=0 ? `+$${l.amount}` : `-$${Math.abs(l.amount)}`}
                        </div>
                      </div>
                      <div className="text-[11px] font-semibold text-gray-600">{new Date(l.ts).toLocaleString()}</div>
                    </div>
                  )) : <div className="text-sm font-semibold text-gray-700">å°šç„¡è¨˜å¸³ç´€éŒ„ã€‚</div>}
                </div>
              </div>
            </div>
          </div>
        );
      }

      function FinanceLedgerForm({ onAdd }){
        const [name, setName] = useState("");
        const [amount, setAmount] = useState("");

        return (
          <div className="mt-3 grid grid-cols-1 gap-2">
            <input
              className="border-2 border-black rounded-2xl px-3 py-2 text-sm font-semibold bg-white"
              placeholder="åç¨±ï¼ˆä¾‹ï¼šäº¤é€šã€é¤è²»ã€è£œåŠ©ï¼‰"
              value={name}
              onChange={(e)=>setName(e.target.value)}
            />
            <input
              className="border-2 border-black rounded-2xl px-3 py-2 text-sm font-semibold bg-white"
              placeholder="é‡‘é¡ï¼ˆæ”¶å…¥æ­£æ•¸ / æ”¯å‡ºè² æ•¸ï¼‰"
              value={amount}
              onChange={(e)=>setAmount(e.target.value)}
              inputMode="numeric"
            />
            <button
              className="neo-btn w-full rounded-2xl py-3 bg-white font-pixel text-4xl"
              onClick={()=>{
                onAdd && onAdd(name.trim(), Number(amount));
                setName("");
                setAmount("");
              }}
            >
              æ–°å¢ä¸€ç­†
            </button>
          </div>
        );
      }

      /********************
       * Render: Home / Apps
       ********************/
      function TopNav({ title, onHome }){
        return (
          <div className="p-3 bg-white border-b-2 border-black flex items-center justify-between gap-2">
            <div className="font-pixel text-5xl leading-none">{title}</div>
            <button className="neo-btn px-3 py-2 rounded-2xl bg-white font-pixel text-4xl inline-flex items-center gap-2" onClick={onHome}>
              <IconHome /> Home
            </button>
          </div>
        );
      }

      function renderOnboarding(){
        return (
          <div className="h-full flex flex-col">
            <div className="p-3 border-b-2 border-black bg-white">
              <div className="font-pixel text-6xl leading-none">è‡ªç«‹å¤§å†’éšª</div>
              <div className="text-xs font-semibold text-gray-700">è‡ªç«‹ç”Ÿæ´»æ¨¡æ“¬å™¨ï½œå…ˆæŠ½å‘½é‹ï¼Œå†åšé¸æ“‡ã€‚</div>
            </div>

            <div className="p-3 flex-1 overflow-auto">
              {phase === "wheel" ? (
                <div className="neo-card p-4">
                  <div className="font-pixel text-5xl leading-none">Onboardingï½œå‘½é‹è½‰ç›¤</div>
                  <div className="mt-2 text-sm font-semibold text-gray-800">
                    é»ä¸‹æŒ‰éˆ•å¾Œæœƒè½‰ 2 ç§’ï¼Œä¾æ©Ÿç‡æŠ½å‡ºåˆå§‹é‡‘é¡ç­‰ç´šï¼ˆA~Eï¼‰ï¼Œä¸¦éš¨æ©Ÿå¹´é½¡ 15~19ã€‚
                  </div>

                  <div className="mt-4 flex items-center justify-center">
                    <div className={"w-44 h-44 rounded-full border-2 border-black bg-white flex items-center justify-center " + (spinning ? "glitch-effect" : "")}
                         style={{ boxShadow: "6px 6px 0 #000" }}>
                      <div className={"font-pixel text-6xl " + (spinning ? "animate-pulse" : "")}>ğŸ¡</div>
                    </div>
                  </div>

                  <button className={"neo-btn w-full mt-4 rounded-2xl py-3 bg-emerald-200 font-pixel text-5xl " + (spinning ? "opacity-70" : "")}
                          onClick={spinDestiny} disabled={spinning}>
                    {spinning ? "è½‰å‹•ä¸­..." : "é–‹å§‹è½‰å‹•"}
                  </button>

                  <div className="mt-3 text-xs font-semibold text-gray-700">
                    æ©Ÿç‡ï¼šA 0.1 / B 0.3 / C 0.3 / D 0.2 / E 0.1
                  </div>
                </div>
              ) : null}

              {phase === "identity" ? (
                <div className="neo-card p-4">
                  <div className="font-pixel text-5xl leading-none">èº«åˆ†ç¢ºèªå¡</div>
                  <div className="mt-2 grid grid-cols-2 gap-2">
                    <div className="neo-soft p-3">
                      <div className="text-xs font-semibold text-gray-700">åˆå§‹ç­‰ç´š</div>
                      <div className="font-pixel text-5xl">{origin ? origin.grade : "-"}</div>
                      <div className="text-xs font-semibold text-gray-700">{origin ? origin.label : ""}</div>
                    </div>
                    <div className="neo-soft p-3">
                      <div className="text-xs font-semibold text-gray-700">å¹´é½¡</div>
                      <div className="font-pixel text-5xl">{age}</div>
                      <div className="text-xs font-semibold text-gray-700">æ­²</div>
                    </div>
                    <div className="neo-soft p-3 col-span-2">
                      <div className="text-xs font-semibold text-gray-700">èµ·å§‹é‡‘é¡</div>
                      <div className="font-pixel text-6xl">${money}</div>
                    </div>
                  </div>

                  <button className="neo-btn w-full mt-4 rounded-2xl py-3 bg-white font-pixel text-5xl"
                          onClick={()=> setPhase("password")}>
                    ä¸‹ä¸€æ­¥ï¼šç¬¬ä¸€é—œï¼ˆæ‰‹æ©Ÿå¯†ç¢¼ï¼‰
                  </button>
                </div>
              ) : null}

              {phase === "password" ? (
                <div className="neo-card p-4">
                  <div className="font-pixel text-5xl leading-none">ç¬¬ä¸€é—œï¼šæ‰‹æ©Ÿå¯†ç¢¼</div>
                  <div className="mt-2 text-sm font-semibold text-gray-800">
                    ä½ çš„æ‰‹æ©Ÿæ˜¯ä½ è‡ªç«‹ç”Ÿæ´»çš„é‡è¦å·¥å…·ã€‚ä½ æœƒæ€éº¼è¨­å®šå®‰å…¨ï¼Ÿ
                  </div>

                  <div className="mt-4 grid grid-cols-1 gap-2">
                    <button className="neo-btn w-full rounded-2xl py-3 bg-rose-200 font-pixel text-5xl"
                            onClick={()=> choosePassword("weak")}>
                      1) 123456ï¼ˆè³‡å®‰ -20ï¼‰
                    </button>
                    <button className="neo-btn w-full rounded-2xl py-3 bg-emerald-200 font-pixel text-5xl"
                            onClick={()=> choosePassword("2fa")}>
                      2) é–‹å•Ÿ 2FAï¼ˆè³‡å®‰ +10ï¼‰
                    </button>
                  </div>

                  <div className="mt-3 text-xs font-semibold text-gray-700">
                    é¸æ“‡å¾Œç›´æ¥é€²å…¥ Homeã€‚
                  </div>
                </div>
              ) : null}
            </div>
          </div>
        );
      }

      function renderHome(){
        const livingCost = computeLivingCost();
        const showMoodWarn = mood < 30;
        const showBillWarn = bills.length > 0;

        return (
          <div className={"h-full flex flex-col " + (glitch ? "glitch-effect" : "")}>
            <StatBar week={week} maxWeeks={maxWeeks} health={health} mood={mood} security={security} ap={ap} maxAp={maxAp} livingCost={livingCost} />

            <div className="p-3 space-y-3 overflow-auto">
              <div className="neo-card p-3">
                <div className="flex items-center justify-between gap-2">
                  <div>
                    <div className="font-pixel text-5xl leading-none">Home</div>
                    <div className="text-xs font-semibold text-gray-700">å¹´é½¡ï¼š{age}ï½œå±…ä½ï¼š{hasHouse ? houseName : "å°šæœªç©©å®šå±…æ‰€"}</div>
                  </div>
                  <div className="text-right">
                    <div className="text-xs font-semibold text-gray-700">é¤˜é¡</div>
                    <div className={"font-pixel text-6xl leading-none " + (money < 0 ? "text-rose-700" : "text-black")}>${money}</div>
                  </div>
                </div>

                {showBillWarn ? (
                  <div className="mt-3 border-2 border-black rounded-2xl p-2 bg-rose-50">
                    <div className="text-sm font-bold text-rose-800">âš ï¸ æœªç¹³å¸³å–®æé†’ï¼š{bills.length} ç­†</div>
                    <div className="text-xs font-semibold text-rose-800">å»ºè­°åˆ°ã€Œè²¡å‹™ç®¡å®¶ã€æŸ¥çœ‹åˆ†æœŸ/ä¿¡ç”¨æ‰£æ¬¾ã€‚</div>
                  </div>
                ) : null}

                {showMoodWarn ? (
                  <div className="mt-3 border-2 border-black rounded-2xl p-2 bg-yellow-50">
                    <div className="text-sm font-bold text-yellow-800">âš ï¸ å¿ƒæƒ…åä½ï¼ˆ{mood}ï¼‰</div>
                    <div className="text-xs font-semibold text-yellow-800">å»ºè­°åˆ°ã€Œè³‡æºåœ°åœ–ã€å°‹æ±‚æ”¯æŒæˆ–å®‰æ’ä¼‘æ¯ã€‚</div>
                  </div>
                ) : null}
              </div>

              <div className="grid grid-cols-2 gap-3">
                <AppIcon
                  title="ç§Ÿå±‹ä¸­å¿ƒ"
                  subtitle="çœ‹æˆ¿æ¸¬é©—ï¼‹ç°½ç´„æ¢æ¬¾"
                  onClick={()=> setScreen("app_house")}
                  Icon={<IconHouse />}
                  tone="bg-white"
                />
                <AppIcon
                  title="äººåŠ›éŠ€è¡Œ"
                  subtitle="æ‡‰å¾µæ¸¬é©—ï¼ˆæŠ½ 3 é¡Œï¼‰"
                  onClick={()=> setScreen("app_job")}
                  Icon={<IconBriefcase />}
                  tone="bg-white"
                />
                <AppIcon
                  title="è³‡æºåœ°åœ–"
                  subtitle="å°±æœ/ç¦åˆ©/CCSA/è­¦å±€"
                  onClick={()=> setScreen("app_resource")}
                  Icon={<IconMap />}
                  tone="bg-white"
                />
                <AppIcon
                  title="è²¡å‹™ç®¡å®¶"
                  subtitle="å¸³å–®ï¼‹å•†åº—ï¼‹è¨˜å¸³"
                  onClick={()=> setScreen("app_finance")}
                  Icon={<IconWallet />}
                  tone="bg-white"
                />
              </div>

              <button className="neo-btn w-full rounded-2xl py-3 bg-emerald-200 font-pixel text-5xl" onClick={advanceWeek}>
                çµæŸæœ¬é€± / ä¼‘æ¯ï¼ˆä¸‹ä¸€é€±ï¼‰
              </button>

              <div className="neo-card p-3 bg-black text-emerald-300">
                <div className="font-pixel text-5xl leading-none">SYSTEM LOGS</div>
                <div className="mt-2 space-y-1">
                  {logs.slice(-5).reverse().map(l=>(
                    <div key={l.id} className="text-xs font-mono text-emerald-200">
                      â–¸ {l.text}
                    </div>
                  ))}
                  {!logs.length ? <div className="text-xs font-mono text-emerald-200">ï¼ˆå°šç„¡ç´€éŒ„ï¼‰</div> : null}
                </div>
              </div>
            </div>
          </div>
        );
      }

      function renderJobApp(){
        return (
          <div className="h-full flex flex-col">
            <TopNav title="äººåŠ›éŠ€è¡Œ" onHome={()=>setScreen("home")} />
            <div className="p-3">
              <div className="text-xs font-semibold text-gray-700">
                æ‡‰å¾µæœƒæ¶ˆè€— 1 APï¼Œä¸¦é€²è¡Œ 3 é¡Œé¢è©¦æ¸¬é©—ï¼ˆå…¨å°æ‰é€šéï¼‰ã€‚
              </div>
            </div>
            <div className="px-3 pb-3 space-y-3 overflow-auto">
              {JOBS.map(job=>{
                const ageOk = age >= job.minAge;
                const canByAccompany = (!ageOk && hasItem("accompaniment_card") && !job.strictAge);
                const ok = ageOk || canByAccompany;
                return (
                  <div key={job.id} className="neo-card p-3">
                    <div className="flex items-start justify-between gap-2">
                      <div>
                        <div className="font-pixel text-5xl leading-none">{job.title}</div>
                        <div className="text-xs font-semibold text-gray-700">{job.desc}</div>
                      </div>
                      <div className="flex flex-col items-end gap-1">
                        <SmallBadge text={ok ? "å¹´é½¡ OK" : `éœ€${job.minAge}+`} tone={ok ? "bg-emerald-100 text-emerald-700" : "bg-rose-100 text-rose-700"} />
                        <SmallBadge text={job.strictAge ? "åš´æ ¼" : "ä¸€èˆ¬"} tone={job.strictAge ? "bg-black text-white" : "bg-gray-100 text-gray-800"} />
                      </div>
                    </div>

                    <div className="mt-3 grid grid-cols-4 gap-2">
                      <div className="neo-soft p-2">
                        <div className="text-[11px] font-bold">æ™‚è–ª</div>
                        <div className="font-pixel text-4xl">{job.wage}</div>
                      </div>
                      <div className="neo-soft p-2">
                        <div className="text-[11px] font-bold">é«”åŠ›</div>
                        <div className="font-pixel text-4xl">-{job.energy}</div>
                      </div>
                      <div className="neo-soft p-2">
                        <div className="text-[11px] font-bold">å¿ƒæƒ…</div>
                        <div className="font-pixel text-4xl">{job.mood >=0 ? `+${job.mood}` : job.mood}</div>
                      </div>
                      <div className="neo-soft p-2">
                        <div className="text-[11px] font-bold">AP</div>
                        <div className="font-pixel text-4xl">-1</div>
                      </div>
                    </div>

                    <button
                      className={"neo-btn w-full mt-3 rounded-2xl py-3 font-pixel text-5xl " + (ap<=0 ? "bg-gray-200 opacity-70" : "bg-emerald-200")}
                      onClick={()=> startJobApply(job)}
                      disabled={ap<=0}
                    >
                      ç¢ºèªæ‡‰å¾µ
                    </button>
                  </div>
                );
              })}
            </div>
          </div>
        );
      }

      function renderHouseApp(){
        return (
          <div className="h-full flex flex-col">
            <TopNav title="ç§Ÿå±‹ä¸­å¿ƒ" onHome={()=>setScreen("home")} />
            <div className="p-3">
              <div className="text-xs font-semibold text-gray-700">
                é ç´„çœ‹æˆ¿æœƒæ¶ˆè€— 1 APï¼Œé€²è¡Œ 3 é¡Œæ¸¬é©—ï¼ˆå…¨å°æ‰å¯ç°½ç´„ï¼‰ã€‚
                æœªæ»¿ 18 æ­²ä¸”ç„¡ã€Œç¤¾å·¥é™ªåŒå¡ã€æ™‚ï¼Œé™¤ CCSA å¤–ä¸å¯ç°½ç´„ã€‚
              </div>
            </div>

            <div className="px-3 pb-3 space-y-3 overflow-auto">
              {hasHouse ? (
                <div className="neo-card p-3 bg-emerald-50">
                  <div className="font-pixel text-5xl leading-none">å·²å…¥ä½</div>
                  <div className="mt-1 text-sm font-semibold text-gray-900">{houseName}</div>
                  <div className="text-xs font-semibold text-gray-700">æç¤ºï¼šé CCSA ä½å®¿æ¯é€±åŸºæœ¬æ”¯å‡ºæœƒå¤š +500ã€‚</div>
                </div>
              ) : null}

              {HOUSING.map(h=>{
                const isCCSA = h.tag === "ccsa";
                const under18Blocked = (age < 18 && !isCCSA && !hasItem("accompaniment_card"));
                return (
                  <div key={h.id} className="neo-card p-3">
                    <div className="flex items-start justify-between gap-2">
                      <div>
                        <div className="font-pixel text-5xl leading-none">{h.title}</div>
                        <div className="text-xs font-semibold text-gray-700">{h.desc}</div>
                      </div>
                      <div className="flex flex-col items-end gap-1">
                        <SmallBadge text={isCCSA ? "CCSA" : "ä¸€èˆ¬"} tone={isCCSA ? "bg-emerald-100 text-emerald-700" : "bg-gray-100 text-gray-800"} />
                        {under18Blocked ? <SmallBadge text="æœªæ»¿18éœ€é™ªåŒ" tone="bg-rose-100 text-rose-700" /> : null}
                      </div>
                    </div>

                    <div className="mt-3 grid grid-cols-3 gap-2">
                      <div className="neo-soft p-2">
                        <div className="text-[11px] font-bold">ç§Ÿé‡‘</div>
                        <div className="font-pixel text-4xl">{h.rent}</div>
                      </div>
                      <div className="neo-soft p-2">
                        <div className="text-[11px] font-bold">æŠ¼é‡‘</div>
                        <div className="font-pixel text-4xl">{h.deposit}</div>
                      </div>
                      <div className="neo-soft p-2">
                        <div className="text-[11px] font-bold">è³‡å®‰</div>
                        <div className="font-pixel text-4xl">{h.securityDelta >=0 ? `+${h.securityDelta}` : h.securityDelta}</div>
                      </div>
                    </div>

                    <button
                      className={"neo-btn w-full mt-3 rounded-2xl py-3 font-pixel text-5xl " + (ap<=0 ? "bg-gray-200 opacity-70" : "bg-emerald-200")}
                      onClick={() => openHouseQuiz(h)}
                      disabled={ap<=0}
                    >
                      é ç´„çœ‹æˆ¿ï¼ˆ-1 APï¼‰
                    </button>
                  </div>
                );
              })}
            </div>
          </div>
        );
      }

      function renderResourceApp(){
        return (
          <div className="h-full flex flex-col">
            <TopNav title="è³‡æºåœ°åœ–" onHome={()=>setScreen("home")} />
            <div className="p-3 space-y-3 overflow-auto">
              <div className="neo-card p-3">
                <div className="font-pixel text-5xl leading-none">å°±æ¥­æœå‹™ç«™</div>
                <div className="text-xs font-semibold text-gray-700">å®Œæˆ job_testï¼ˆå…¨å°ï¼‰å¯ç² $1000ã€‚</div>
                <button className={"neo-btn w-full mt-2 rounded-2xl py-3 font-pixel text-5xl " + (ap<=0?"bg-gray-200 opacity-70":"bg-emerald-200")}
                        onClick={()=> doResourceAction("job_test")} disabled={ap<=0}>
                  é€²è¡Œå°±æ¥­æ¸¬é©—ï¼ˆ-1 APï¼‰
                </button>
              </div>

              <div className="neo-card p-3">
                <div className="font-pixel text-5xl leading-none">ç¤¾æœƒç¦åˆ©ä¸­å¿ƒ</div>
                <div className="text-xs font-semibold text-gray-700">ç¦åˆ©æ”¯æŒï¼šhealth +20ï¼›è²¡å‹™æ€¥é›£ï¼šmoney < 2000 æ‰èƒ½ç”³è«‹ã€‚</div>
                <div className="grid grid-cols-1 gap-2 mt-2">
                  <button className={"neo-btn w-full rounded-2xl py-3 font-pixel text-5xl " + (ap<=0?"bg-gray-200 opacity-70":"bg-emerald-200")}
                          onClick={()=> doResourceAction("welfare_help")} disabled={ap<=0}>
                    ç¦åˆ©æ”¯æŒï¼ˆ-1 APï¼‰
                  </button>
                  <button className={"neo-btn w-full rounded-2xl py-3 font-pixel text-5xl " + (ap<=0?"bg-gray-200 opacity-70":"bg-white")}
                          onClick={()=> doResourceAction("finance_help")} disabled={ap<=0}>
                    è²¡å‹™æ€¥é›£ï¼ˆ-1 APï¼‰
                  </button>
                </div>
              </div>

              <div className="neo-card p-3">
                <div className="font-pixel text-5xl leading-none">CCSA è‡ªç«‹æœå‹™</div>
                <div className="text-xs font-semibold text-gray-700">
                  ä½ å¯ä»¥ç”³è«‹è‡ªç«‹å”åŠ©ã€ç¤¾å·¥é™ªåŒã€è«®å•†æ”¯æŒèˆ‡è‡ªç«‹åŸ¹è¨“ã€‚
                </div>
                <div className="grid grid-cols-1 gap-2 mt-2">
                  <button className={"neo-btn w-full rounded-2xl py-3 font-pixel text-5xl " + (ap<=0?"bg-gray-200 opacity-70":"bg-emerald-200")}
                          onClick={()=> doResourceAction("ccsa_aid")} disabled={ap<=0}>
                    CCSA è‡ªç«‹å”åŠ©ï¼ˆ-1 APï¼‰
                  </button>
                  <button className={"neo-btn w-full rounded-2xl py-3 font-pixel text-5xl " + (ap<=0?"bg-gray-200 opacity-70":"bg-white")}
                          onClick={()=> doResourceAction("apply_accompaniment")} disabled={ap<=0}>
                    ç”³è«‹ç¤¾å·¥é™ªåŒï¼ˆ-1 APï¼‰
                  </button>
                  <button className={"neo-btn w-full rounded-2xl py-3 font-pixel text-5xl " + (ap<=0?"bg-gray-200 opacity-70":"bg-emerald-200")}
                          onClick={()=> doResourceAction("ccsa_counseling")} disabled={ap<=0}>
                    å¿ƒç†è«®å•†ï¼ˆ-1 APï¼‰
                  </button>
                  <button className={"neo-btn w-full rounded-2xl py-3 font-pixel text-5xl " + (ap<=0?"bg-gray-200 opacity-70":"bg-white")}
                          onClick={()=> doResourceAction("ccsa_training")} disabled={ap<=0}>
                    è‡ªç«‹åŸ¹è¨“ï¼ˆ-1 APï¼‰
                  </button>
                </div>
              </div>

              <div className="neo-card p-3">
                <div className="font-pixel text-5xl leading-none">è­¦å¯Ÿå±€</div>
                <div className="text-xs font-semibold text-gray-700">18+ å¯é ˜ good_citizen_cardï¼›æœªæ»¿ 18 éœ€æ³•ä»£/ç›£è­·äººã€‚</div>
                <button className="neo-btn w-full mt-2 rounded-2xl py-3 bg-white font-pixel text-5xl"
                        onClick={()=> doResourceAction("police_good_card")}>
                  ç”³è«‹è‰¯æ°‘å¡
                </button>
              </div>
            </div>
          </div>
        );
      }

      /********************
       * Main render switch
       ********************/
      const livingCost = computeLivingCost();

      return (
        <div className="absolute inset-0 flex flex-col">
          <FloatingTextOverlay floats={floats} />

          {/* Modals */}
          {modal?.kind === "info" ? (
            <InfoModal title={modal.title} body={modal.body} onClose={modal.onClose} />
          ) : null}

          {modal?.kind === "quiz" ? (
            <QuizModal
              title={modal.title}
              questions={modal.questions}
              onCancel={modal.onCancel}
              onSubmit={modal.onSubmit}
            />
          ) : null}

          {modal?.kind === "event" ? (
            <ModalWrapper
              open={true}
              title={modal.title}
              onClose={modal.onClose}
              footer={null}
            >
              <div className="text-sm font-semibold text-gray-900 whitespace-pre-wrap">{modal.body}</div>
              <div className="mt-3 grid grid-cols-1 gap-2">
                {(modal.choices||[]).map((c, idx)=>(
                  <button key={idx} className="neo-btn w-full rounded-2xl py-3 bg-emerald-200 font-pixel text-4xl"
                          onClick={()=> applyScenarioChoice(c)}>
                    {c.label}
                  </button>
                ))}
                <button className="neo-btn w-full rounded-2xl py-3 bg-white font-pixel text-4xl" onClick={()=>{ setModal(null); setScreen("home"); }}>
                  å–æ¶ˆï¼ˆå› Homeï¼‰
                </button>
              </div>
            </ModalWrapper>
          ) : null}

          {modal?.kind === "shop" ? (
            <ModalWrapper
              open={true}
              title={modal.title || "å•†åº—"}
              onClose={modal.onClose}
              footer={null}
            >
              <div className="text-xs font-semibold text-gray-700">
                ä»˜æ¬¾æ–¹å¼ï¼šç¾é‡‘ / ä¿¡ç”¨å¡ï¼ˆä¸‹é€±æ‰£ï¼‰/ BNPLï¼ˆ+20% åˆ†4é€±æ‰£ï¼‰
              </div>
              <div className="mt-3 space-y-3 max-h-[62vh] overflow-auto pr-1">
                {SHOP_ITEMS.map(it=>(
                  <div key={it.id} className="border-2 border-black rounded-2xl p-3 bg-white">
                    <div className="flex items-start justify-between gap-2">
                      <div>
                        <div className="font-pixel text-5xl leading-none">{it.title}</div>
                        <div className="text-xs font-semibold text-gray-700">{it.desc}</div>
                        {it.scam ? (
                          <div className="mt-1 text-xs font-bold text-rose-700">âš ï¸ è©é¨™å“é …</div>
                        ) : null}
                      </div>
                      <div className="font-pixel text-5xl leading-none">${it.price}</div>
                    </div>

                    <div className="mt-2 grid grid-cols-3 gap-2">
                      <button className="neo-btn rounded-2xl py-2 bg-emerald-200 font-pixel text-4xl"
                              onClick={()=> buyItem(it, "cash")}>
                        ç¾é‡‘
                      </button>
                      <button className="neo-btn rounded-2xl py-2 bg-white font-pixel text-4xl"
                              onClick={()=> buyItem(it, "credit")}>
                        ä¿¡ç”¨
                      </button>
                      <button className="neo-btn rounded-2xl py-2 bg-yellow-200 font-pixel text-4xl"
                              onClick={()=> buyItem(it, "bnpl")}>
                        BNPL
                      </button>
                    </div>
                  </div>
                ))}
              </div>
            </ModalWrapper>
          ) : null}

          {/* Screens */}
          <div className={"flex-1 min-h-0 " + (glitch ? "glitch-effect" : "")}>
            {screen === "onboarding" ? renderOnboarding() : null}
            {screen === "home" ? renderHome() : null}
            {screen === "app_job" ? renderJobApp() : null}
            {screen === "app_house" ? renderHouseApp() : null}
            {screen === "app_resource" ? renderResourceApp() : null}
            {screen === "app_finance" ? renderFinanceApp() : null}
          </div>

          {/* Low mood/security subtle banner */}
          {(mood < 30 || security < 30) ? (
            <div className="absolute left-3 right-3 bottom-3 z-30">
              <div className="neo-card p-2 bg-black text-white">
                <div className="flex items-center justify-between gap-2">
                  <div className="font-pixel text-4xl leading-none">âš ï¸ è­¦ç¤º</div>
                  <div className="text-xs font-semibold">
                    {mood < 30 ? `å¿ƒæƒ…åä½ï¼ˆ${mood}ï¼‰` : ""}{mood < 30 && security < 30 ? "ï½œ" : ""}{security < 30 ? `è³‡å®‰åä½ï¼ˆ${security}ï¼‰` : ""}
                  </div>
                </div>
              </div>
            </div>
          ) : null}
        </div>
      );
    }

    ReactDOM.createRoot(document.getElementById("root")).render(<App />);
  </script>

</body>
</html>

